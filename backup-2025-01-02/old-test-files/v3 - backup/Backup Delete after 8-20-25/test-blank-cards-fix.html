<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Jam.dev Recording & Capture -->
    <meta name="jam:team" content="89d666eb-996b-4246-949a-939265963095" />
    <script type="module" src="https://js.jam.dev/recorder.js"></script>
    <script type="module" src="https://js.jam.dev/capture.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blank Cards Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #111;
            color: #fff;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .slot-machine {
            display: flex;
            gap: 20px;
            margin: 40px 0;
            justify-content: center;
        }
        
        .slot-column {
            width: 120px;
            position: relative;
        }
        
        .column-header {
            text-align: center;
            padding: 10px;
            background: #333;
            color: #fff;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .slot-window {
            height: 240px;
            border: 2px solid #555;
            overflow: hidden;
            position: relative;
            background: #222;
        }
        
        .slot-items {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
        }
        
        .slot-item {
            height: 80px;
            border: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #333;
            color: #fff;
            font-size: 12px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .slot-item.winner-item {
            background: #006600 !important;
            border-color: #00ff00 !important;
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            background: #ff3366;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 0 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button:hover {
            background: #ff5577;
        }
        
        .debug-info {
            background: #222;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Blank Cards Fix Test</h1>
        <p>This test verifies that the slot machine columns always show items and never have blank/empty areas at the bottom.</p>
        
        <div class="controls">
            <button onclick="testSlotMachine()">Test Slot Machine</button>
            <button onclick="resetColumns()">Reset Columns</button>
            <button onclick="inspectColumns()">Inspect Columns</button>
        </div>
        
        <div class="slot-machine">
            <div class="slot-column" data-type="weapon">
                <div class="column-header">WEAPON</div>
                <div class="slot-window">
                    <div class="slot-items"></div>
                </div>
            </div>
            
            <div class="slot-column" data-type="specialization">
                <div class="column-header">SPECIALIZATION</div>
                <div class="slot-window">
                    <div class="slot-items"></div>
                </div>
            </div>
            
            <div class="slot-column" data-type="gadget-1">
                <div class="column-header">GADGET 1</div>
                <div class="slot-window">
                    <div class="slot-items"></div>
                </div>
            </div>
            
            <div class="slot-column" data-type="gadget-2">
                <div class="column-header">GADGET 2</div>
                <div class="slot-window">
                    <div class="slot-items"></div>
                </div>
            </div>
            
            <div class="slot-column" data-type="gadget-3">
                <div class="column-header">GADGET 3</div>
                <div class="slot-window">
                    <div class="slot-items"></div>
                </div>
            </div>
        </div>
        
        <div id="debug-output" class="debug-info"></div>
    </div>

    <script src="slot-machine.js"></script>
    <script src="animation-engine-v2.js"></script>
    
    <script>
        // Test data
        const TestData = {
            Light: {
                weapons: ["SR-84", "LH1", "Sword", "93R", "Dagger", "SH1900", "M26 Matter", "Recurve Bow", "M11", "ARN-220", "V9S", "XP-54"],
                specializations: ["Cloaking Device", "Evasive Dash", "Grappling Hook"],
                gadgets: ["Breach Charge", "Gateway", "Glitch Grenade", "Flashbang", "Frag Grenade", "Gas Grenade", "Goo Grenade", "Pyro Grenade", "Smoke Grenade", "Stun Gun", "Thermal Vision", "Tracking Dart"]
            }
        };

        let slotMachine;
        let debugOutput = document.getElementById('debug-output');

        function log(message) {
            console.log(message);
            debugOutput.textContent += message + '\n';
        }

        function clearLog() {
            debugOutput.textContent = '';
        }

        async function testSlotMachine() {
            clearLog();
            log('üöÄ Starting blank cards fix test...\n');
            
            try {
                // Initialize slot machine
                if (!slotMachine) {
                    // Mock global data
                    window.GameData = {
                        loadouts: TestData
                    };
                    
                    slotMachine = new SlotMachine();
                }
                
                log('‚úÖ Slot machine initialized\n');
                
                // Test spin
                log('üé∞ Testing spin with Light class...\n');
                const result = await slotMachine.spin('Light', 1);
                
                if (result) {
                    log('‚úÖ Spin completed successfully!');
                    log(`Result: ${JSON.stringify(result, null, 2)}\n`);
                } else {
                    log('‚ùå Spin failed or returned null\n');
                }
                
                // Inspect columns after spin
                inspectColumns();
                
            } catch (error) {
                log(`‚ùå Test failed with error: ${error.message}\n`);
                console.error(error);
            }
        }

        function resetColumns() {
            clearLog();
            log('üîÑ Resetting columns...\n');
            
            const columns = document.querySelectorAll('.slot-column');
            columns.forEach(column => {
                const itemsContainer = column.querySelector('.slot-items');
                if (itemsContainer) {
                    itemsContainer.innerHTML = '';
                    itemsContainer.style.transform = 'translateY(0)';
                    itemsContainer.style.filter = 'none';
                }
            });
            
            log('‚úÖ Columns reset\n');
        }

        function inspectColumns() {
            log('\nüîç Inspecting columns for blank areas...\n');
            
            const columns = document.querySelectorAll('.slot-column');
            columns.forEach((column, index) => {
                const columnType = column.getAttribute('data-type');
                const itemsContainer = column.querySelector('.slot-items');
                const slotWindow = column.querySelector('.slot-window');
                
                if (!itemsContainer) {
                    log(`‚ùå Column ${columnType}: No items container found`);
                    return;
                }
                
                const items = itemsContainer.querySelectorAll('.slot-item');
                const currentTransform = itemsContainer.style.transform;
                let translateY = 0;
                const match = currentTransform.match(/translateY\\((-?\\d+(?:\\.\\d+)?)px\\)/);
                if (match) {
                    translateY = parseFloat(match[1]);
                }
                
                log(`Column ${columnType}:`);
                log(`  - Items count: ${items.length}`);
                log(`  - Transform: ${currentTransform}`);
                log(`  - TranslateY: ${translateY}px`);
                
                // Check viewport coverage
                const windowRect = slotWindow.getBoundingClientRect();
                const containerRect = itemsContainer.getBoundingClientRect();
                
                log(`  - Window height: ${windowRect.height}px`);
                log(`  - Container top: ${containerRect.top - windowRect.top}px (relative to window)`);
                
                // Calculate which items should be visible
                const startIndex = Math.floor(-translateY / 80);
                const endIndex = startIndex + 3;
                
                log(`  - Expected visible items: ${startIndex} to ${endIndex}`);
                
                // Check if viewport is covered
                let visibleItems = 0;
                let hasBlankArea = false;
                
                for (let i = Math.max(0, startIndex); i <= Math.min(items.length - 1, endIndex + 1); i++) {
                    if (items[i]) {
                        visibleItems++;
                    }
                }
                
                // Simple blank detection: if we have fewer visible items than expected
                if (visibleItems < 3) {
                    hasBlankArea = true;
                    log(`  ‚ö†Ô∏è Potential blank area! Only ${visibleItems} visible items (expected 3+)`);
                } else {
                    log(`  ‚úÖ Good coverage: ${visibleItems} visible items`);
                }
                
                // Check if the bottom of the viewport might be blank
                const lastVisibleIndex = Math.floor((-translateY + 240) / 80);
                if (lastVisibleIndex >= items.length) {
                    log(`  ‚ö†Ô∏è Bottom of viewport extends beyond items! Last visible index: ${lastVisibleIndex}, total items: ${items.length}`);
                    hasBlankArea = true;
                }
                
                if (!hasBlankArea) {
                    log(`  ‚úÖ No blank areas detected`);
                }
                
                log(''); // Empty line between columns
            });
        }

        // Auto-initialize on load
        window.addEventListener('load', () => {
            log('üìã Test page loaded. Click "Test Slot Machine" to begin.\n');
        });
    </script>
</body>
</html>