<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE FINALS - Team Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Orbitron', monospace;
        }
        
        .neon-glow {
            text-shadow: 0 0 10px rgba(168, 85, 247, 0.8), 0 0 20px rgba(168, 85, 247, 0.6);
        }
        
        .cyber-border {
            border: 2px solid;
            border-image: linear-gradient(45deg, #a855f7, #fbbf24) 1;
        }
        
        .glow-input:focus {
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
        }
        
        .skill-bar {
            background: linear-gradient(90deg, #10b981 0%, #fbbf24 50%, #ef4444 100%);
        }
        
        .collapsible-section {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-black text-purple-400 neon-glow mb-2">
                THE FINALS TEAM BUILDER
            </h1>
            <p class="text-xl text-yellow-400">BALANCED MATCHMAKING SYSTEM</p>
            <div class="mt-4">
                <a href="../" class="text-yellow-400 hover:text-yellow-300 transition-colors">
                    ← Back to Dashboard
                </a>
                <span class="text-gray-500 mx-2">|</span>
                <a href="../admin/index.html" class="text-yellow-400 hover:text-yellow-300 transition-colors">
                    Admin Panel
                </a>
            </div>
        </header>

        <!-- CSV Upload Section -->
        <section class="mb-8">
            <div class="bg-gray-800 rounded-lg p-6 cyber-border">
                <h2 class="text-2xl font-bold mb-4 text-purple-400">IMPORT PLAYERS FROM CSV</h2>
                <div class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1">
                        <label class="block mb-2 text-gray-300">Upload CSV File</label>
                        <input 
                            type="file" 
                            id="csvFile"
                            accept=".csv"
                            class="w-full p-3 bg-gray-700 rounded border border-purple-500 focus:outline-none glow-input file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-bold file:bg-purple-600 file:text-white hover:file:bg-purple-700"
                        >
                    </div>
                    <div class="flex gap-2">
                        <button 
                            onclick="importCSV()"
                            class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded font-bold transition-colors"
                        >
                            IMPORT CSV
                        </button>
                        <button 
                            onclick="downloadTemplate()"
                            class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded font-bold transition-colors"
                        >
                            DOWNLOAD TEMPLATE
                        </button>
                    </div>
                </div>
                <p class="text-sm text-gray-400 mt-2">
                    CSV must have columns: Player Name, Matches Played, Wins, Eliminations, Deaths, Total Damage, Total Cash Extracted
                </p>
            </div>
        </section>

        <!-- Stats Input Section -->
        <section class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-purple-400">ADD PLAYER STATS (MANUAL ENTRY)</h2>
                <button 
                    onclick="toggleManualEntry()"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded font-bold transition-colors text-sm"
                >
                    <span id="toggleIcon">▼</span> TOGGLE
                </button>
            </div>
            <form id="playerForm" class="bg-gray-800 rounded-lg p-6 cyber-border transition-all duration-300" style="display: none;">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block mb-2 text-gray-300">Player Name</label>
                        <input 
                            type="text" 
                            id="playerName"
                            placeholder="xXx_Sniper_xXx"
                            required
                            class="w-full p-3 bg-gray-700 rounded border border-purple-500 focus:outline-none glow-input"
                        >
                    </div>
                    <div>
                        <label class="block mb-2 text-gray-300">Matches Played</label>
                        <input 
                            type="number" 
                            id="matches"
                            placeholder="9266"
                            required
                            min="1"
                            class="w-full p-3 bg-gray-700 rounded border border-purple-500 focus:outline-none glow-input"
                        >
                    </div>
                    <div>
                        <label class="block mb-2 text-gray-300">Wins</label>
                        <input 
                            type="number" 
                            id="wins"
                            placeholder="3917"
                            required
                            min="0"
                            class="w-full p-3 bg-gray-700 rounded border border-purple-500 focus:outline-none glow-input"
                        >
                    </div>
                    <div>
                        <label class="block mb-2 text-gray-300">Eliminations</label>
                        <input 
                            type="number" 
                            id="eliminations"
                            placeholder="44423"
                            required
                            min="0"
                            class="w-full p-3 bg-gray-700 rounded border border-purple-500 focus:outline-none glow-input"
                        >
                    </div>
                    <div>
                        <label class="block mb-2 text-gray-300">Deaths</label>
                        <input 
                            type="number" 
                            id="deaths"
                            placeholder="46829"
                            required
                            min="0"
                            class="w-full p-3 bg-gray-700 rounded border border-purple-500 focus:outline-none glow-input"
                        >
                    </div>
                    <div>
                        <label class="block mb-2 text-gray-300">Total Damage</label>
                        <input 
                            type="number" 
                            id="damage"
                            placeholder="15434478"
                            required
                            min="0"
                            class="w-full p-3 bg-gray-700 rounded border border-purple-500 focus:outline-none glow-input"
                        >
                    </div>
                    <div>
                        <label class="block mb-2 text-gray-300">Total Cash Extracted</label>
                        <input 
                            type="number" 
                            id="cashout"
                            placeholder="206454289"
                            required
                            min="0"
                            class="w-full p-3 bg-gray-700 rounded border border-purple-500 focus:outline-none glow-input"
                        >
                    </div>
                </div>
                <button 
                    type="submit"
                    class="w-full md:w-auto px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded font-bold transition-colors"
                >
                    ADD PLAYER
                </button>
            </form>
        </section>

        <!-- Player List -->
        <section class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-purple-400">PLAYER ROSTER</h2>
                <div class="flex gap-2">
                    <button 
                        onclick="exportRosterCSV()"
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded font-bold transition-colors text-sm"
                    >
                        EXPORT ROSTER
                    </button>
                    <button 
                        onclick="clearAllPlayers()"
                        class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded font-bold transition-colors text-sm"
                    >
                        CLEAR ALL
                    </button>
                </div>
            </div>
            <div id="playerList" class="space-y-2">
                <!-- Players will be added here -->
            </div>
        </section>

        <!-- Team Builder Controls -->
        <section class="mb-8">
            <div class="bg-gray-800 rounded-lg p-6 cyber-border">
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <div class="flex-1">
                        <label class="block mb-2 text-gray-300">Number of Teams</label>
                        <select 
                            id="teamCount"
                            class="w-full p-3 bg-gray-700 rounded border border-purple-500 focus:outline-none glow-input"
                        >
                            <option value="2">2 Teams</option>
                            <option value="3">3 Teams</option>
                            <option value="4">4 Teams</option>
                            <option value="5">5 Teams</option>
                            <option value="6">6 Teams</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block mb-2 text-gray-300">&nbsp;</label>
                        <button 
                            onclick="buildTeams()"
                            class="w-full p-3 bg-yellow-600 hover:bg-yellow-700 rounded font-bold transition-colors"
                        >
                            BUILD BALANCED TEAMS
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Teams Display -->
        <section id="teamsDisplay" class="hidden">
            <h2 class="text-2xl font-bold mb-4 text-purple-400">BALANCED TEAMS</h2>
            <div id="teamsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Teams will be displayed here -->
            </div>
        </section>

        <!-- Export Options -->
        <section id="exportSection" class="hidden mt-8">
            <div class="bg-gray-800 rounded-lg p-6 cyber-border text-center">
                <button 
                    onclick="exportToJSON()"
                    class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded font-bold transition-colors mr-4"
                >
                    EXPORT TO JSON
                </button>
                <button 
                    onclick="copyTeamsText()"
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded font-bold transition-colors"
                >
                    COPY TEAMS TEXT
                </button>
            </div>
        </section>

        <!-- Algorithm Reference -->
        <section class="mt-12 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-purple-400">TEAM BUILDING ALGORITHM REFERENCE</h2>
                <button 
                    onclick="toggleAlgorithmReference()"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded font-bold transition-colors text-sm"
                >
                    <span id="algorithmToggleIcon">▼</span> TOGGLE
                </button>
            </div>
            <div id="algorithmReference" class="bg-gray-800 rounded-lg p-6 cyber-border transition-all duration-300" style="display: none;">
                <h3 class="text-xl font-bold mb-3 text-yellow-400">Player Skill Score Formula</h3>
                <pre class="bg-gray-900 p-4 rounded text-sm overflow-x-auto text-gray-300"><code>// Calculate composite skill score for each player
function calculateSkillScore(stats) {
  const kd = stats.eliminations / stats.deaths;
  const winRate = stats.wins / stats.matches;
  const avgDamage = stats.damage / stats.matches;
  const avgCashout = stats.cashout / stats.matches;
  
  // Normalize each metric (0-100 scale)
  const kdScore = Math.min(kd * 50, 100);  // KD of 2.0 = 100
  const winScore = winRate * 100;          // Direct percentage
  const damageScore = Math.min(avgDamage / 2000 * 100, 100);  // 2000 avg = 100
  const cashoutScore = Math.min(avgCashout / 25000 * 100, 100); // 25k avg = 100
  
  // Weighted average
  return (kdScore * 0.3) + (winScore * 0.3) + (damageScore * 0.25) + (cashoutScore * 0.15);
}</code></pre>

                <h3 class="text-xl font-bold mb-3 mt-6 text-yellow-400">Team Building Algorithm</h3>
                <pre class="bg-gray-900 p-4 rounded text-sm overflow-x-auto text-gray-300"><code>// Snake draft approach for balanced teams
function buildBalancedTeams(players, teamCount) {
  // Sort players by skill score
  players.sort((a, b) => b.skillScore - a.skillScore);
  
  // Initialize teams
  const teams = Array(teamCount).fill().map(() => []);
  
  // Snake draft distribution
  players.forEach((player, index) => {
    const round = Math.floor(index / teamCount);
    const position = index % teamCount;
    
    // Reverse order every other round
    const teamIndex = round % 2 === 0 ? position : teamCount - 1 - position;
    teams[teamIndex].push(player);
  });
  
  return teams;
}</code></pre>

                <div class="mt-4 text-sm text-gray-400">
                    <p class="mb-2"><strong class="text-yellow-400">Skill Score Weights:</strong></p>
                    <ul class="list-disc list-inside space-y-1 ml-4">
                        <li>K/D Ratio: 30%</li>
                        <li>Win Rate: 30%</li>
                        <li>Average Damage: 25%</li>
                        <li>Average Cashout: 15%</li>
                    </ul>
                    
                    <p class="mt-4 mb-2"><strong class="text-yellow-400">Snake Draft Distribution:</strong></p>
                    <p class="ml-4">Players are sorted by skill score and distributed in a snake pattern to ensure balanced teams. 
                    For example, with 3 teams: Team A gets players 1, 6, 7, 12... Team B gets players 2, 5, 8, 11... Team C gets players 3, 4, 9, 10...</p>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Player storage
        let players = [];
        let teams = [];

        // Parse a single CSV line handling quotes and commas or semicolons
        function parseCSVLine(line, delimiter = null) {
            // Auto-detect delimiter if not provided
            if (!delimiter) {
                const commaCount = (line.match(/,/g) || []).length;
                const semicolonCount = (line.match(/;/g) || []).length;
                delimiter = semicolonCount > commaCount ? ';' : ',';
            }
            
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === delimiter && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim()); // Don't forget the last value
            
            // Remove quotes from values
            return values.map(v => v.replace(/^"|"$/g, '').trim());
        }

        // Toggle manual entry form
        function toggleManualEntry() {
            const form = document.getElementById('playerForm');
            const icon = document.getElementById('toggleIcon');
            
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
                icon.textContent = '▲';
            } else {
                form.style.display = 'none';
                icon.textContent = '▼';
            }
        }

        // Toggle algorithm reference
        function toggleAlgorithmReference() {
            const section = document.getElementById('algorithmReference');
            const icon = document.getElementById('algorithmToggleIcon');
            
            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'block';
                icon.textContent = '▲';
            } else {
                section.style.display = 'none';
                icon.textContent = '▼';
            }
        }

        // Load players from localStorage on page load
        function loadPlayersFromStorage() {
            const stored = localStorage.getItem('finalsTeamBuilderPlayers');
            if (stored) {
                try {
                    players = JSON.parse(stored);
                    updatePlayerList();
                } catch (e) {
                    console.error('Error loading players from storage:', e);
                }
            }
        }

        // Save players to localStorage
        function savePlayersToStorage() {
            localStorage.setItem('finalsTeamBuilderPlayers', JSON.stringify(players));
        }

        // Clear all players
        function clearAllPlayers() {
            if (confirm('Are you sure you want to clear all players? This cannot be undone.')) {
                players = [];
                localStorage.removeItem('finalsTeamBuilderPlayers');
                updatePlayerList();
                document.getElementById('teamsDisplay').classList.add('hidden');
                document.getElementById('exportSection').classList.add('hidden');
            }
        }

        // Import CSV
        function importCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file first');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    // Handle different line endings (Windows, Mac, Unix)
                    const lines = csv.split(/\r?\n/).filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSV file appears to be empty');
                        return;
                    }
                    
                    // Parse headers - handle potential BOM and quotes
                    const firstLine = lines[0].replace(/^\uFEFF/, ''); // Remove BOM if present
                    
                    // Detect delimiter
                    const commaCount = (firstLine.match(/,/g) || []).length;
                    const semicolonCount = (firstLine.match(/;/g) || []).length;
                    const delimiter = semicolonCount > commaCount ? ';' : ',';
                    
                    console.log('Detected delimiter:', delimiter === ';' ? 'semicolon' : 'comma');
                    
                    const headers = parseCSVLine(firstLine, delimiter);
                    
                    console.log('Raw first line:', firstLine);
                    console.log('CSV Headers found:', headers);
                    
                    // Expected column names - try multiple variations
                    const expectedHeaders = {
                        'Player Name': 'name',
                        'Matches Played': 'matches',
                        'Wins': 'wins',
                        'Eliminations': 'eliminations',
                        'Deaths': 'deaths',
                        'Total Damage': 'damage',
                        'Total Cash Extracted': 'cashout'
                    };
                    
                    // Also try without spaces
                    const alternativeHeaders = {
                        'PlayerName': 'name',
                        'MatchesPlayed': 'matches',
                        'Wins': 'wins',
                        'Eliminations': 'eliminations',
                        'Deaths': 'deaths',
                        'TotalDamage': 'damage',
                        'TotalCashExtracted': 'cashout'
                    };
                    
                    // Map headers to indices - be flexible with matching
                    const headerMap = {};
                    const missingHeaders = [];
                    
                    // Try to find each required header
                    Object.keys(expectedHeaders).forEach(expected => {
                        let index = headers.findIndex(h => h.toLowerCase() === expected.toLowerCase());
                        
                        // If not found, try alternative names
                        if (index === -1 && alternativeHeaders[expected.replace(/ /g, '')]) {
                            index = headers.findIndex(h => h.toLowerCase() === expected.replace(/ /g, '').toLowerCase());
                        }
                        
                        if (index === -1) {
                            missingHeaders.push(expected);
                        } else {
                            headerMap[expectedHeaders[expected]] = index;
                        }
                    });
                    
                    if (missingHeaders.length > 0) {
                        alert(`Missing required columns:\n${missingHeaders.join('\n')}\n\nFound columns:\n${headers.join('\n')}`);
                        return;
                    }
                    
                    // Parse data rows
                    const importedPlayers = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue; // Skip empty lines
                        
                        const values = parseCSVLine(lines[i], delimiter);
                        
                        if (values.length < headers.length) {
                            console.log(`Skipping row ${i + 1}: insufficient columns`);
                            continue;
                        }
                        
                        const player = {
                            name: values[headerMap.name]?.replace(/^"|"$/g, ''), // Remove quotes if present
                            matches: parseInt(values[headerMap.matches]?.replace(/,/g, '')) || 0,
                            wins: parseInt(values[headerMap.wins]?.replace(/,/g, '')) || 0,
                            eliminations: parseInt(values[headerMap.eliminations]?.replace(/,/g, '')) || 0,
                            deaths: parseInt(values[headerMap.deaths]?.replace(/,/g, '')) || 0,
                            damage: parseInt(values[headerMap.damage]?.replace(/,/g, '')) || 0,
                            cashout: parseInt(values[headerMap.cashout]?.replace(/,/g, '')) || 0
                        };
                        
                        // Validate data
                        if (!player.name || player.name.length === 0) {
                            console.log(`Skipping row ${i + 1}: no player name`);
                            continue;
                        }
                        
                        if (player.matches <= 0) {
                            console.log(`Skipping row ${i + 1}: invalid matches count`);
                            continue;
                        }
                        
                        console.log(`Importing player: ${player.name}`);
                        player.skillScore = calculateSkillScore(player);
                        importedPlayers.push(player);
                    }
                    
                    if (importedPlayers.length === 0) {
                        alert('No valid player data found in CSV');
                        return;
                    }
                    
                    // Add to existing players or replace
                    if (players.length > 0) {
                        if (confirm(`Found ${importedPlayers.length} players in CSV. Add to existing ${players.length} players or replace all?`)) {
                            players = players.concat(importedPlayers);
                        } else {
                            players = importedPlayers;
                        }
                    } else {
                        players = importedPlayers;
                    }
                    
                    savePlayersToStorage();
                    updatePlayerList();
                    fileInput.value = '';
                    alert(`Successfully imported ${importedPlayers.length} players!`);
                    
                } catch (error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        // Download CSV template
        function downloadTemplate() {
            const template = 'Player Name,Matches Played,Wins,Eliminations,Deaths,Total Damage,Total Cash Extracted\n' +
                            'ExamplePlayer,1000,500,5000,4000,2000000,50000000\n';
            
            const blob = new Blob([template], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'finals_team_builder_template.csv';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Export roster to CSV
        function exportRosterCSV() {
            if (players.length === 0) {
                alert('No players to export');
                return;
            }
            
            let csv = 'Player Name,Matches Played,Wins,Eliminations,Deaths,Total Damage,Total Cash Extracted,Skill Score\n';
            
            players.forEach(player => {
                csv += `${player.name},${player.matches},${player.wins},${player.eliminations},${player.deaths},${player.damage},${player.cashout},${player.skillScore.total}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'finals_team_roster.csv';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Calculate skill score
        function calculateSkillScore(stats) {
            const kd = stats.deaths > 0 ? stats.eliminations / stats.deaths : stats.eliminations;
            const winRate = stats.wins / stats.matches;
            const avgDamage = stats.damage / stats.matches;
            const avgCashout = stats.cashout / stats.matches;
            
            // Normalize each metric (0-100 scale)
            const kdScore = Math.min(kd * 50, 100);  // KD of 2.0 = 100
            const winScore = winRate * 100;          // Direct percentage
            const damageScore = Math.min(avgDamage / 2000 * 100, 100);  // 2000 avg = 100
            const cashoutScore = Math.min(avgCashout / 25000 * 100, 100); // 25k avg = 100
            
            // Weighted average
            const score = (kdScore * 0.3) + (winScore * 0.3) + (damageScore * 0.25) + (cashoutScore * 0.15);
            
            return {
                total: Math.round(score * 10) / 10,
                kd: Math.round(kd * 100) / 100,
                winRate: Math.round(winRate * 1000) / 10,
                avgDamage: Math.round(avgDamage),
                avgCashout: Math.round(avgCashout)
            };
        }

        // Add player
        document.getElementById('playerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const player = {
                name: document.getElementById('playerName').value,
                matches: parseInt(document.getElementById('matches').value),
                wins: parseInt(document.getElementById('wins').value),
                eliminations: parseInt(document.getElementById('eliminations').value),
                deaths: parseInt(document.getElementById('deaths').value),
                damage: parseInt(document.getElementById('damage').value),
                cashout: parseInt(document.getElementById('cashout').value)
            };
            
            player.skillScore = calculateSkillScore(player);
            players.push(player);
            
            savePlayersToStorage();
            updatePlayerList();
            this.reset();
            document.getElementById('playerName').focus();
        });

        // Update player list display
        function updatePlayerList() {
            const container = document.getElementById('playerList');
            container.innerHTML = '';
            
            // Sort by skill score
            const sortedPlayers = [...players].sort((a, b) => b.skillScore.total - a.skillScore.total);
            
            sortedPlayers.forEach((player, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'bg-gray-800 rounded-lg p-4 cyber-border';
                
                // Determine skill tier color
                let tierColor = 'text-green-400';
                if (player.skillScore.total < 40) tierColor = 'text-red-400';
                else if (player.skillScore.total < 70) tierColor = 'text-yellow-400';
                
                playerDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <span class="text-xl font-bold">${player.name}</span>
                            <span class="ml-4 ${tierColor} font-bold">Score: ${player.skillScore.total}</span>
                        </div>
                        <div class="text-sm text-gray-400">
                            K/D: ${player.skillScore.kd} | Win: ${player.skillScore.winRate}% | 
                            Dmg/Match: ${player.skillScore.avgDamage.toLocaleString()}
                        </div>
                        <button 
                            onclick="removePlayer(${players.indexOf(player)})"
                            class="ml-4 px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm"
                        >
                            REMOVE
                        </button>
                    </div>
                    <div class="mt-2">
                        <div class="h-2 bg-gray-700 rounded overflow-hidden">
                            <div class="h-full skill-bar" style="width: ${player.skillScore.total}%"></div>
                        </div>
                    </div>
                `;
                
                container.appendChild(playerDiv);
            });
        }

        // Remove player
        function removePlayer(index) {
            players.splice(index, 1);
            savePlayersToStorage();
            updatePlayerList();
        }

        // Build balanced teams
        function buildTeams() {
            const teamCount = parseInt(document.getElementById('teamCount').value);
            
            if (players.length < teamCount) {
                alert(`Need at least ${teamCount} players for ${teamCount} teams!`);
                return;
            }
            
            // Sort players by skill score
            const sortedPlayers = [...players].sort((a, b) => b.skillScore.total - a.skillScore.total);
            
            // Initialize teams
            teams = Array(teamCount).fill().map(() => []);
            
            // Snake draft distribution
            sortedPlayers.forEach((player, index) => {
                const round = Math.floor(index / teamCount);
                const position = index % teamCount;
                
                // Reverse order every other round
                const teamIndex = round % 2 === 0 ? position : teamCount - 1 - position;
                teams[teamIndex].push(player);
            });
            
            displayTeams();
        }

        // Display teams
        function displayTeams() {
            document.getElementById('teamsDisplay').classList.remove('hidden');
            document.getElementById('exportSection').classList.remove('hidden');
            
            const container = document.getElementById('teamsContainer');
            container.innerHTML = '';
            
            teams.forEach((team, index) => {
                const teamAvg = team.reduce((sum, p) => sum + p.skillScore.total, 0) / team.length || 0;
                
                const teamDiv = document.createElement('div');
                teamDiv.className = 'bg-gray-800 rounded-lg p-4 cyber-border';
                
                teamDiv.innerHTML = `
                    <h3 class="text-xl font-bold mb-3 text-yellow-400">
                        TEAM ${String.fromCharCode(65 + index)}
                        <span class="text-sm text-gray-400 ml-2">Avg: ${teamAvg.toFixed(1)}</span>
                    </h3>
                    <div class="space-y-2">
                        ${team.map(player => `
                            <div class="bg-gray-700 rounded p-2">
                                <div class="font-bold">${player.name}</div>
                                <div class="text-sm text-gray-400">
                                    Score: ${player.skillScore.total} | K/D: ${player.skillScore.kd}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(teamDiv);
            });
        }

        // Export to JSON
        function exportToJSON() {
            const exportData = {
                players: players,
                teams: teams.map((team, index) => ({
                    name: `Team ${String.fromCharCode(65 + index)}`,
                    players: team,
                    avgSkillScore: team.reduce((sum, p) => sum + p.skillScore.total, 0) / team.length || 0
                }))
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'finals-teams.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Copy teams as text
        function copyTeamsText() {
            let text = 'THE FINALS - BALANCED TEAMS\n\n';
            
            teams.forEach((team, index) => {
                const teamAvg = team.reduce((sum, p) => sum + p.skillScore.total, 0) / team.length || 0;
                text += `TEAM ${String.fromCharCode(65 + index)} (Avg Score: ${teamAvg.toFixed(1)})\n`;
                team.forEach(player => {
                    text += `- ${player.name} (Score: ${player.skillScore.total}, K/D: ${player.skillScore.kd})\n`;
                });
                text += '\n';
            });
            
            navigator.clipboard.writeText(text).then(() => {
                alert('Teams copied to clipboard!');
            });
        }

        // Load sample data for testing
        function loadSampleData() {
            const samplePlayers = [
                { name: "1-800-FAT-MOMS", matches: 9266, wins: 3917, eliminations: 44423, deaths: 46829, damage: 15434478, cashout: 206454289 },
                { name: "xXx_Sniper_xXx", matches: 5000, wins: 2500, eliminations: 30000, deaths: 20000, damage: 10000000, cashout: 125000000 },
                { name: "CashGrabber", matches: 3000, wins: 1200, eliminations: 15000, deaths: 18000, damage: 6000000, cashout: 80000000 },
                { name: "DefuseKing", matches: 4000, wins: 1800, eliminations: 20000, deaths: 15000, damage: 8000000, cashout: 100000000 },
                { name: "HeavyMetal", matches: 2500, wins: 800, eliminations: 10000, deaths: 12000, damage: 5000000, cashout: 50000000 },
                { name: "LightSpeed", matches: 6000, wins: 3000, eliminations: 35000, deaths: 25000, damage: 12000000, cashout: 150000000 }
            ];
            
            samplePlayers.forEach(p => {
                p.skillScore = calculateSkillScore(p);
                players.push(p);
            });
            
            updatePlayerList();
        }
        
        // Initialize - Load players from localStorage when page loads
        window.addEventListener('DOMContentLoaded', function() {
            loadPlayersFromStorage();
        });
        
        // Uncomment to load sample data for testing
        // loadSampleData();
    </script>
</body>
</html>