<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="canonical" href="https://www.thefinalsloadout.com/" />

    <!-- Performance Hints -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link rel="dns-prefetch" href="https://static.cloudflareinsights.com" />

    <!-- Preload Critical Resources - Logo is LCP element -->
    <!-- Removed unused preload: <link rel="preload" href="/images/the-finals-logo.webp" as="image" type="image/webp" fetchpriority="high" /> -->

    <!-- Meta Tags -->
    <title>The Finals BEST Random Loadout Generator | Fun & Unique Loadouts</title>
    <meta name="description" content="Get the best random loadouts for The Finals game to have fun and be challenged. Find new weapon builds for Light, Medium, and Heavy playstyles." />
    <meta name="author" content="Paul Takisaki" />
    <link rel="author" href="https://www.paultakisaki.com/" />

    <!-- Open Graph -->
    <meta property="og:title" content="The Finals Loadout Roulette" />
    <meta property="og:description" content="Randomize your loadout and dominate The Finals with style." />
    <meta property="og:image" content="https://www.thefinalsloadout.com/images/TFL social 1200x1200.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="1200" />
    <meta property="og:url" content="https://www.thefinalsloadout.com/" />
    <meta property="og:type" content="website" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="The Finals Loadout Roulette" />
    <meta name="twitter:description" content="Spin the wheel. Wreck the arena." />
    <meta name="twitter:image" content="https://www.thefinalsloadout.com/images/TFL social 1200x1200.png" />

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "The Finals Loadout Generator",
        "url": "https://www.thefinalsloadout.com",
        "description": "A random loadout generator for The Finals game with optimized weapons and gadgets for different playstyles.",
        "image": "https://www.thefinalsloadout.com/images/the-finals-logo.webp",
        "author": {
            "@type": "Person",
            "name": "Paul Takisaki",
            "url": "https://www.paultakisaki.com"
        }
    }
    </script>

    <!-- Fonts - Optimized Loading (Non-blocking) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <!-- Load fonts asynchronously to prevent render blocking -->
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;900&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;900&display=swap" media="print" onload="this.media='all'; this.onload=null;">
    <noscript>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;900&display=swap">
    </noscript>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />

    <!-- Google Analytics (GA4) - Optimized Lazy Loading -->
    <script>
        // Lazy load GTM after page becomes interactive for better performance
        // This saves 52.3 KiB from initial load and improves Core Web Vitals
        window.addEventListener('load', function() {
            setTimeout(function() {
                // Create and load GTM script
                const script = document.createElement('script');
                script.async = true;
                script.src = 'https://www.googletagmanager.com/gtag/js?id=G-GVGKYFGZ1Z';

                // Initialize GTM after script loads
                script.onload = function() {
                    window.dataLayer = window.dataLayer || [];
                    function gtag() {
                        dataLayer.push(arguments);
                    }
                    window.gtag = gtag;
                    gtag("js", new Date());
                    gtag("config", "G-GVGKYFGZ1Z");
                    console.log('📊 Analytics loaded successfully');
                };

                document.head.appendChild(script);
            }, 1000); // Delay 1 second after page load
        });
    </script>

    <!-- Console noise control for production -->
    <script>
        window.DEBUG = false;
        if (!window.DEBUG) {
            console.log = function() {};
            console.debug = function() {};
        }
    </script>
    
    <!-- Premium Styles - Extracted for Performance -->
    <link rel="stylesheet" href="/premium-styles.css">
    
    <style>
        /* Critical inline styles for immediate render - rest in premium-styles.css */
        body { background: #0a0a0a; color: #fff; font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
    <!-- Scroll Progress Bar -->
    <div class="scroll-progress-container">
        <div class="scroll-progress-bar" id="scrollProgress"></div>
    </div>
    
    <!-- Simple Working Mobile Menu -->
    <style>
        /* Hide mobile menu button on desktop */
        @media (min-width: 769px) {
            #menuBtn, #simpleMenu, #menuOverlay {
                display: none !important;
            }
        }
        
        /* Mobile styles */
        @media (max-width: 768px) {
            /* Hide desktop nav on mobile */
            .desktop-nav {
                display: none !important;
            }
            #simpleMenu {
                position: fixed;
                top: 0;
                left: -280px;
                width: 280px;
                height: 100vh;
                background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
                z-index: 99999;
                transition: left 0.3s ease;
                padding-top: 60px;
                box-shadow: 5px 0 20px rgba(0,0,0,0.7);
                border-right: 2px solid rgba(255, 51, 102, 0.3);
            }
            #simpleMenu.show {
                left: 0;
            }
            #simpleMenu a:hover {
                background: rgba(255, 51, 102, 0.1);
                padding-left: 25px;
            }
            #menuBtn {
                position: fixed;
                top: 10px;
                left: 10px;
                z-index: 100000;
                background: rgba(26, 26, 26, 0.95);
                color: #ff3366;
                border: 1px solid rgba(255, 51, 102, 0.3);
                border-radius: 8px;
                padding: 10px 12px;
                cursor: pointer;
                font-size: 20px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                transition: all 0.3s;
            }
            #menuBtn:hover {
                background: rgba(255, 51, 102, 0.1);
                transform: scale(1.1);
            }
            
            /* Dark overlay */
            #menuOverlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 99998;
                display: none;
            }
            #menuOverlay.show {
                display: block;
            }
        }
    </style>
    
    <button id="menuBtn" onclick="document.getElementById('simpleMenu').classList.toggle('show'); document.getElementById('menuOverlay').classList.toggle('show')">☰</button>
    
    <div id="menuOverlay" onclick="document.getElementById('simpleMenu').classList.remove('show'); this.classList.remove('show')"></div>
    
    <div id="simpleMenu">
        <a href="/index.html" style="display:block;color:white;padding:15px;border-bottom:1px solid #333;text-decoration:none;transition:all 0.3s;">LOADOUT GENERATOR</a>
        <a href="/ragequit/" style="display:block;color:white;padding:15px;border-bottom:1px solid #333;text-decoration:none;transition:all 0.3s;">RAGE QUIT</a>
        <a href="/patch-notes/" style="display:block;color:white;padding:15px;border-bottom:1px solid #333;text-decoration:none;transition:all 0.3s;">PATCH NOTES</a>
        <a href="/meta-weapons/" style="display:block;color:white;padding:15px;border-bottom:1px solid #333;text-decoration:none;transition:all 0.3s;">META WEAPONS</a>
        <a href="/wt-progress/" style="display:block;color:white;padding:15px;border-bottom:1px solid #333;text-decoration:none;transition:all 0.3s;">WORLD TOUR</a>
        <a href="#" onclick="return false;" style="display:block;color:#888;padding:15px;border-bottom:1px solid #333;text-decoration:none;cursor:not-allowed;">SPOTLIGHT (Coming Soon)</a>
    </div>
    
    <!-- Navigation Bar (Desktop) -->
    <nav class="main-nav desktop-nav">
        <div class="nav-links desktop-nav-links">
            <a href="/index.html" class="nav-link active">LOADOUT GENERATOR</a>
            <a href="/ragequit/" class="nav-link">RAGE QUIT</a>
            <a href="/patch-notes/" class="nav-link">PATCH NOTES</a>
            <a href="/meta-weapons/" class="nav-link">META WEAPONS</a>
            <a href="/wt-progress/" class="nav-link">WORLD TOUR</a>
            <a href="#" onclick="return false;" class="nav-link" style="color:#888;cursor:not-allowed;">SPOTLIGHT (Coming Soon)</a>
        </div>
    </nav>

    <!-- Streamer Spotlight Pill -->
    <div style="display: none; text-align: center; margin: 10px 0;">
        <a href="/spotlight" style="display: inline-block; padding: 6px 16px; background: linear-gradient(135deg, #ec4899, #8b5cf6); color: white; font-size: 0.875rem; font-weight: 600; border-radius: 9999px; text-decoration: none; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 8px rgba(236, 72, 153, 0.3);"
           onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(236, 72, 153, 0.5)';"
           onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(236, 72, 153, 0.3)';">
            ✨ Streamer Spotlight: ks_rachel
        </a>
    </div>

    <!-- Header -->
    <header class="header">
        <!-- Logo image - easy to revert by uncommenting text below and removing img -->
        <img src="/images/logo final.webp" alt="The Finals Premium Slot Machine" class="header-logo">
        <!-- Previous logos: 
        <img src="/images/logo-header.webp" alt="The Finals Premium Slot Machine" class="header-logo">
        <img src="/images/logo-header-v2.webp" alt="The Finals Premium Slot Machine" class="header-logo"> 
        -->
        <!-- Original text header (backup) - uncomment to restore:
        <h1 class="title">THE FINALS</h1>
        <h1 class="title">PREMIUM SLOT MACHINE</h1>
        <p class="subtitle">Vegas-Style Loadout Generator</p>
        -->
        
        <!-- Credibility Badge -->
        <a href="https://ko-fi.com/nextroundonme" target="_blank" rel="noopener noreferrer" class="credibility-badge" aria-label="No ads, no tracking, no login required loadout generator">
            <div class="badge-top">NO ADS • NO TRACKING • NO LOGIN</div>
            <div class="badge-main">
                <span class="badge-text">
                    <span class="text-default">Built solo, kept simple</span>
                    <span class="text-hover">
                        <span class="hover-icon">❤️</span>
                        Support Me
                    </span>
                </span>
            </div>
        </a>

        <style>
            a.credibility-badge {
                display: inline-block;
                margin: 15px auto 10px;
                background: rgba(20, 20, 20, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                padding: 8px 20px;
                border-radius: 12px;
                user-select: none;
                animation: subtlePulse 2s ease-out;
                transition: all 0.3s ease-out;
                z-index: 10;
                text-decoration: none;
                color: inherit;
                overflow: hidden;
            }

            @keyframes subtlePulse {
                0% {
                    transform: scale(0.98);
                    opacity: 0;
                }
                50% {
                    opacity: 1;
                }
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            .badge-top {
                font-size: 9px;
                letter-spacing: 2px;
                opacity: 0.7;
                margin-bottom: 4px;
                text-align: center;
                font-weight: 600;
            }

            .badge-main {
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 13px;
                font-weight: 500;
                cursor: pointer;
                position: relative;
            }

            .badge-icon {
                font-size: 14px;
                transition: transform 0.3s ease-out;
            }

            .badge-text {
                position: relative;
                height: 18px;
                width: 145px;
                display: flex;
                align-items: center;
                overflow: hidden;
            }

            .text-default,
            .text-hover {
                position: absolute;
                white-space: nowrap;
                transition: opacity 0.25s ease-out;
                width: 100%;
                text-align: center;
                left: 0;
            }

            .text-default {
                opacity: 1;
            }

            .text-hover {
                opacity: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 4px;
            }

            .hover-icon {
                font-size: 12px;
                animation: none;
            }

            a.credibility-badge:hover .text-default {
                opacity: 0;
            }

            a.credibility-badge:hover .text-hover {
                opacity: 1;
            }

            a.credibility-badge:hover .hover-icon {
                animation: heartBeat 1s ease-out infinite;
            }

            @keyframes heartBeat {
                0%, 100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.1);
                }
            }

            a.credibility-badge:hover {
                background: rgba(30, 30, 30, 0.15);
                border-color: rgba(255, 255, 255, 0.15);
                transform: scale(1.02);
            }

            /* Mobile adjustments */
            @media (max-width: 768px) {
                a.credibility-badge {
                    margin: 10px auto;
                    transform: none;
                }

                a.credibility-badge:hover {
                    transform: none;
                }

                .badge-main {
                    cursor: default;
                }

                .text-hover {
                    display: none;
                }

                @keyframes subtlePulse {
                    0% {
                        transform: scale(0.98);
                        opacity: 0;
                    }
                    50% {
                        opacity: 1;
                    }
                    100% {
                        transform: scale(1);
                        opacity: 1;
                    }
                }
            }

            /* Very small mobile screens */
            @media (max-width: 480px) {
                a.credibility-badge {
                    padding: 6px 12px;
                }

                .badge-top {
                    font-size: 8px;
                    letter-spacing: 1.5px;
                }

                .badge-main {
                    font-size: 12px;
                }

                .badge-icon {
                    font-size: 12px;
                }
            }
        </style>
    </header>

    <!-- Premium Slot Machine Container -->
    <div class="slot-machine-premium">
        <!-- Controls Section -->
        <div class="controls-section">
            <!-- Random Everything Button -->
            <button class="random-all-premium" id="randomAllBtn">
                <span class="dice-icon">🎲</span>
                <span>RANDOM EVERYTHING</span>
            </button>

            <!-- Secondary Filter Button - More prominent placement -->
            <button id="secondary-filter-button" class="secondary-filter-button" aria-label="Customize filters">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="4" y1="6" x2="20" y2="6"></line>
                    <line x1="4" y1="12" x2="20" y2="12"></line>
                    <line x1="4" y1="18" x2="20" y2="18"></line>
                    <circle cx="7" cy="6" r="2" fill="currentColor"></circle>
                    <circle cx="17" cy="12" r="2" fill="currentColor"></circle>
                    <circle cx="10" cy="18" r="2" fill="currentColor"></circle>
                </svg>
                <span>Customize Filters</span>
                <span class="filter-count-badge" id="filter-count-badge" style="display: none;">0</span>
            </button>

            <!-- Selection Grid -->
            <div class="selection-grid">
                <!-- Spin Selection -->
                <div class="selection-panel">
                    <div class="selection-title">Select # of Spins</div>
                    <div class="selection-options">
                        <button class="select-btn spin-btn" data-spins="1">1</button>
                        <button class="select-btn spin-btn" data-spins="2">2</button>
                        <button class="select-btn spin-btn" data-spins="3">3</button>
                        <button class="select-btn spin-btn" data-spins="4">4</button>
                        <button class="select-btn spin-btn" data-spins="5">5</button>
                    </div>
                </div>

                <!-- Class Selection -->
                <div class="selection-panel">
                    <div class="selection-title">Select Your Class</div>
                    <div class="selection-options">
                        <button class="select-btn class-btn-premium" data-class="light">
                            <span class="class-icon-premium">⚡</span>
                            <span>LIGHT</span>
                        </button>
                        <button class="select-btn class-btn-premium" data-class="medium">
                            <span class="class-icon-premium">⚔️</span>
                            <span>MEDIUM</span>
                        </button>
                        <button class="select-btn class-btn-premium" data-class="heavy">
                            <span class="class-icon-premium">🛡️</span>
                            <span>HEAVY</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slot Display Area -->
        <div class="slot-display" id="slotDisplay">
            <div class="spin-counter" id="spinCounter" style="display: none;">
                SPIN <span id="currentSpin">1</span> OF <span id="totalSpins">3</span>
            </div>

            <!-- Slot Columns -->
            <div class="slot-columns" id="premiumSlotColumns">
                <!-- Columns will be dynamically generated -->
            </div>
        </div>

        <!-- Generate Button -->
        <button class="generate-button" id="generateBtn" disabled>
            SELECT OPTIONS ABOVE
        </button>
    </div>

    <!-- Victory Sparks Container -->
    <div class="victory-sparks" id="victorySparks"></div>

    <!-- Hidden container for app initialization -->
    <div id="slot-machine-container" style="display: none;">
        <!-- The app needs this container to initialize -->
    </div>

    <!-- Slot Machine Output Structure (required by app.js) -->
    <div id="output" style="display: none;">
        <div class="items-container">
            <!-- Weapon Column -->
            <div class="slot-column" data-type="weapon">
                <div class="slot-header">WEAPON</div>
                <div class="slot-scroll">
                    <div class="slot-items"></div>
                </div>
            </div>

            <!-- Specialization Column -->
            <div class="slot-column" data-type="specialization">
                <div class="slot-header">SPECIALIZATION</div>
                <div class="slot-scroll">
                    <div class="slot-items"></div>
                </div>
            </div>

            <!-- Gadget 1 Column -->
            <div class="slot-column" data-type="gadget1">
                <div class="slot-header">GADGET 1</div>
                <div class="slot-scroll">
                    <div class="slot-items"></div>
                </div>
            </div>

            <!-- Gadget 2 Column -->
            <div class="slot-column" data-type="gadget2">
                <div class="slot-header">GADGET 2</div>
                <div class="slot-scroll">
                    <div class="slot-items"></div>
                </div>
            </div>

            <!-- Gadget 3 Column -->
            <div class="slot-column" data-type="gadget3">
                <div class="slot-header">GADGET 3</div>
                <div class="slot-scroll">
                    <div class="slot-items"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load the main app scripts -->
    <script src="app-optimized.js?v=20250831-filter-fix"></script>
    
    <!-- Load the premium integration -->
    <script src="premium-integrated.js?v=20250831"></script>
    
    <!-- Victory Sparks positioning fix -->
    <script>
        // Fix sparks container positioning
        window.addEventListener('DOMContentLoaded', () => {
            const sparksContainer = document.getElementById('victorySparks');
            if (sparksContainer) {
                // Move it inside the slot display area
                const slotDisplay = document.getElementById('slotDisplay');
                if (slotDisplay) {
                    slotDisplay.appendChild(sparksContainer);
                    sparksContainer.style.position = 'absolute';
                    sparksContainer.style.top = '50%';
                    sparksContainer.style.left = '50%';
                    sparksContainer.style.transform = 'translate(-50%, -50%)';
                    sparksContainer.style.pointerEvents = 'none';
                    sparksContainer.style.zIndex = '1000';
                }
            }
        });
    </script>
    
    <!-- Victory Sparks Container -->
    <div id="victorySparks"></div>
    
    <!-- Share Loadout Section -->
    <div id="shareSection" class="share-section" style="display: none;">
        <button id="shareLoadout" class="share-button">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                <polyline points="16 6 12 2 8 6"></polyline>
                <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg>
            Share This Loadout
        </button>
    </div>
    
    <!-- Filter Panel -->
    <div class="filter-panel-overlay" id="filter-panel-overlay"></div>
    <div class="filter-panel" id="filter-panel">
        <div class="filter-panel-header">
            <h2 class="filter-panel-title">Filter Equipment</h2>
            <button class="close-filter-panel" id="close-filter-panel">✕</button>
        </div>
        <div id="filter-content">
            <!-- Filter content will be dynamically populated -->
        </div>
        <div class="filter-actions">
            <button class="filter-btn reset-all-filters" id="reset-all-filters">Reset All Filters</button>
            <button class="filter-btn clear-filters" id="clear-filters">Clear</button>
            <button class="filter-btn apply-filters" id="apply-filters">Apply Filters</button>
        </div>
    </div>
    
    <!-- History Section -->
    <section class="history-section">
        <div class="history-container">
            <div class="history-header">
                <h2 class="history-title">
                    <span>🎰</span>
                    <span>Loadout History</span>
                    <span class="history-count" id="historyCount">(0)</span>
                </h2>
                <button class="clear-history-btn" id="clearHistoryBtn">Clear All History</button>
            </div>
            <div class="history-list" id="historyList">
                <div class="empty-history">No loadouts generated yet. Spin the slots to get started!</div>
            </div>
        </div>
    </section>

    <!-- Stream Tools Button and Panel -->
    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <!-- Subtle floating button -->
        <button id="streamToolsBtn" onclick="toggleStreamPanel()"
                style="background: linear-gradient(135deg, #ff4796, #9b59b6);
                       border: none;
                       border-radius: 50%;
                       width: 60px;
                       height: 60px;
                       cursor: pointer;
                       box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                       display: flex;
                       align-items: center;
                       justify-content: center;
                       transition: all 0.3s ease;
                       position: relative;">
            <span style="font-size: 24px;">📺</span>
            <!-- Small badge indicator -->
            <span style="position: absolute; top: -5px; right: -5px;
                        background: linear-gradient(90deg, #00d4ff, #0099ff);
                        color: white;
                        font-size: 10px;
                        padding: 2px 5px;
                        border-radius: 10px;
                        font-weight: bold;
                        animation: pulse 2s infinite;">LIVE</span>
        </button>

        <!-- Stream Tools Backdrop -->
        <div id="streamToolsBackdrop" onclick="closeStreamPanel()" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.3); z-index: 999; cursor: pointer;"></div>

        <!-- Slide-out panel -->
        <div id="streamToolsPanel" style="position: fixed;
                                          right: -400px;
                                          bottom: 90px;
                                          width: 380px;
                                          background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%);
                                          border-radius: 15px;
                                          border: 1px solid rgba(255, 255, 255, 0.1);
                                          box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                                          padding: 20px;
                                          transition: right 0.3s ease;
                                          z-index: 999;">

            <!-- Panel Header -->
            <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <h3 style="margin: 0; background: linear-gradient(90deg, #ff4796, #9b59b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 18px;">🎮 Stream Tools <span style="background: linear-gradient(90deg, #00d4ff, #0099ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 14px;">BETA</span></h3>
                <p style="margin: 5px 0 0 0; color: #888; font-size: 12px;">Live overlay for OBS/Streamlabs</p>
            </div>

            <!-- Quick Actions -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <button onclick="sendLastLoadoutQuick()"
                        style="padding: 10px;
                               background: rgba(255, 71, 150, 0.2);
                               border: 1px solid #ff4796;
                               border-radius: 8px;
                               color: white;
                               cursor: pointer;
                               transition: background 0.2s;"
                        onmouseover="this.style.background='rgba(255, 71, 150, 0.3)'"
                        onmouseout="this.style.background='rgba(255, 71, 150, 0.2)'">
                    📤 Send Current
                </button>
                <button onclick="testOverlayQuick()"
                        style="padding: 10px;
                               background: rgba(76, 175, 80, 0.2);
                               border: 1px solid #4CAF50;
                               border-radius: 8px;
                               color: white;
                               cursor: pointer;
                               transition: background 0.2s;"
                        onmouseover="this.style.background='rgba(76, 175, 80, 0.3)'"
                        onmouseout="this.style.background='rgba(76, 175, 80, 0.2)'">
                    🎲 Test Overlay
                </button>
            </div>

            <!-- Overlay URL -->
            <div style="margin-bottom: 15px;">
                <label style="color: #aaa; font-size: 12px; display: block; margin-bottom: 5px;">Your Overlay URL:</label>
                <div style="background: #000; padding: 8px; border-radius: 5px; display: flex; gap: 5px;">
                    <input type="text" id="quickOverlayUrl" value="https://thefinalsloadout.com/overlay/" readonly
                           style="flex: 1; background: transparent; border: none; color: #fff; font-family: monospace; font-size: 11px;">
                    <button onclick="copyQuickUrl()" style="padding: 4px 8px; background: #ff4796; border: none; border-radius: 3px; color: white; font-size: 11px; cursor: pointer;">📋</button>
                </div>
            </div>

            <!-- Settings Summary -->
            <div style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                <div style="color: #aaa; font-size: 12px; margin-bottom: 8px;">Current Settings:</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px; color: #ccc;">
                    <div>Position: <span id="currentPos" style="color: #ff4796;">Top Right</span></div>
                    <div>Theme: <span id="currentTheme" style="color: #ff4796;">Dark</span></div>
                    <div>Size: <span id="currentSize" style="color: #ff4796;">Normal</span></div>
                    <div>Auto-hide: <span id="currentHide" style="color: #ff4796;">No</span></div>
                    <div style="grid-column: 1 / -1; margin-top: 5px; border-top: 1px solid rgba(255,71,150,0.2); padding-top: 5px;">
                        <strong>OBS Settings:</strong> <span style="color: #ff4796;">600x180</span>
                    </div>
                </div>
            </div>

            <!-- Full Setup Link -->
            <a href="/stream-tools" target="_blank"
               style="display: block;
                      text-align: center;
                      padding: 12px;
                      background: linear-gradient(90deg, #ff4796, #9b59b6);
                      border-radius: 8px;
                      color: white;
                      text-decoration: none;
                      font-weight: bold;
                      transition: transform 0.2s;"
               onmouseover="this.style.transform='translateY(-2px)'"
               onmouseout="this.style.transform='translateY(0)'">
                🚀 Full Setup & Customization → <span style="background: linear-gradient(90deg, #00d4ff, #0099ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold;">BETA</span>
            </a>

            <!-- Status indicator -->
            <div id="streamStatus" style="margin-top: 10px; padding: 8px; background: rgba(76, 175, 80, 0.1); border: 1px solid #4CAF50; border-radius: 5px; text-align: center; font-size: 11px; color: #4CAF50; display: none;">
                ✓ Overlay Active
            </div>
        </div>
    </div>

    <!-- Styles for Stream Tools -->
    <style>
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        #streamToolsBtn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 71, 150, 0.4);
        }

        /* Remember user preference */
        .stream-panel-open {
            right: 20px !important;
        }
    </style>

    <script>
        // Stream Tools Panel Functions
        function toggleStreamPanel() {
            const panel = document.getElementById('streamToolsPanel');
            const backdrop = document.getElementById('streamToolsBackdrop');
            const btn = document.getElementById('streamToolsBtn');

            if (panel.classList.contains('stream-panel-open')) {
                closeStreamPanel();
            } else {
                panel.classList.add('stream-panel-open');
                panel.style.right = '20px';
                backdrop.style.display = 'block';
                localStorage.setItem('streamPanelOpen', 'true');
                checkStreamStatus();
            }
        }

        function closeStreamPanel() {
            const panel = document.getElementById('streamToolsPanel');
            const backdrop = document.getElementById('streamToolsBackdrop');
            panel.classList.remove('stream-panel-open');
            panel.style.right = '-400px';
            backdrop.style.display = 'none';
            localStorage.setItem('streamPanelOpen', 'false');
        }

        function sendLastLoadoutQuick() {
            // Get the last loadout from history
            let historyStr = localStorage.getItem('slotMachineHistory') || localStorage.getItem('premiumSlotHistory');
            if (!historyStr) {
                showQuickStatus('No loadout found! Generate one first.', false);
                return;
            }

            try {
                const history = JSON.parse(historyStr);
                if (history.length === 0) {
                    showQuickStatus('No loadouts in history!', false);
                    return;
                }

                const lastLoadout = history[0];

                // Helper functions for image URLs
                const getImagePath = (itemName) => {
                    if (!itemName || typeof itemName !== 'string') return null;
                    return `images/${itemName.replace(/ /g, "_")}.webp`;
                };

                const getFullImageUrl = (path) => {
                    if (!path) return null;
                    if (path.startsWith('http')) return path;
                    const baseUrl = window.location.origin;
                    return `${baseUrl}/${path}`;
                };

                const getItemName = (item) => typeof item === 'object' ? item.name : item;

                const getItemImageUrl = (item) => {
                    if (typeof item === 'object' && item.image) {
                        return getFullImageUrl(item.image);
                    }
                    const itemName = getItemName(item);
                    const imagePath = getImagePath(itemName);
                    return getFullImageUrl(imagePath);
                };

                // Format for overlay
                const overlayData = {
                    class: lastLoadout.class || lastLoadout.classType || 'Unknown',
                    name: lastLoadout.name || 'Recent Loadout',
                    weapon: {
                        name: getItemName(lastLoadout.weapon),
                        image: getItemImageUrl(lastLoadout.weapon)
                    },
                    specialization: {
                        name: getItemName(lastLoadout.specialization),
                        image: getItemImageUrl(lastLoadout.specialization)
                    },
                    gadgets: lastLoadout.gadgets ? lastLoadout.gadgets.map(g => ({
                        name: getItemName(g),
                        image: getItemImageUrl(g)
                    })) : [],
                    timestamp: new Date().toISOString()
                };

                localStorage.setItem('loadout_overlay_default', JSON.stringify(overlayData));
                // Also store as currentLoadout for stream-tools to pick up
                localStorage.setItem('currentLoadout', JSON.stringify(overlayData));
                console.log('Sent to overlay:', overlayData);

                // Send via Supabase for real-time OBS updates
                sendLoadoutSupabase(overlayData);

                showQuickStatus('✅ Loadout sent to overlay!', true);

            } catch (error) {
                console.error('Error sending loadout:', error);
                showQuickStatus('Error sending loadout!', false);
            }
        }

        function testOverlayQuick() {
            const testData = {
                class: 'Medium',
                name: 'Test Loadout',
                weapon: { name: 'FCAR', image: null },
                specialization: { name: 'Healing Beam', image: null },
                gadgets: [
                    { name: 'Defibrillator', image: null },
                    { name: 'Jump Pad', image: null },
                    { name: 'Gas Mine', image: null }
                ],
                timestamp: new Date().toISOString()
            };

            // Send via Supabase for OBS
            sendLoadoutSupabase(testData);

            // Also save to localStorage for browser preview
            localStorage.setItem('loadout_overlay_default', JSON.stringify(testData));

            showQuickStatus('✅ Test loadout sent!', true);
        }

        function copyQuickUrl() {
            const url = document.getElementById('quickOverlayUrl').value;
            navigator.clipboard.writeText(url).then(() => {
                showQuickStatus('✅ URL copied to clipboard!', true);
            });
        }

        function showQuickStatus(message, success) {
            const status = document.getElementById('streamStatus');
            status.textContent = message;
            status.style.display = 'block';
            status.style.background = success ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255, 0, 0, 0.1)';
            status.style.borderColor = success ? '#4CAF50' : '#ff0000';
            status.style.color = success ? '#4CAF50' : '#ff0000';

            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        function checkStreamStatus() {
            // Check if there's an active overlay session
            const overlayData = localStorage.getItem('loadout_overlay_default');
            if (overlayData) {
                const status = document.getElementById('streamStatus');
                status.textContent = '✓ Overlay Active';
                status.style.display = 'block';
                setTimeout(() => {
                    status.style.display = 'none';
                }, 2000);
            }
        }

        // Load saved preferences on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check if panel should be open
            if (localStorage.getItem('streamPanelOpen') === 'true') {
                const panel = document.getElementById('streamToolsPanel');
                panel.classList.add('stream-panel-open');
                panel.style.right = '20px';
            }

            // Update settings display from localStorage if available
            const settings = localStorage.getItem('overlaySettings');
            if (settings) {
                try {
                    const parsed = JSON.parse(settings);
                    document.getElementById('currentPos').textContent = parsed.position || 'Top Right';
                    document.getElementById('currentTheme').textContent = parsed.theme || 'Dark';
                    document.getElementById('currentSize').textContent = parsed.compact ? 'Compact' : 'Normal';
                    document.getElementById('currentHide').textContent = parsed.hideEmpty ? 'Yes' : 'No';
                } catch (e) {
                    // Use defaults
                }
            }
        });
    </script>

    <!-- Streamer Spotlight Section -->
    <section id="streamer-spotlight" class="rounded-2xl border border-zinc-800 bg-zinc-900/60 p-4 mt-6" style="display: none;">
        <div class="flex items-center gap-3">
            <img src="/images/streamers/ks_rachel.jpg" alt="ks_rachel avatar" class="h-12 w-12 rounded-xl object-cover">
            <div class="flex-1">
                <p class="text-sm uppercase tracking-wide text-pink-300">Streamer Spotlight</p>
                <h3 class="text-xl font-semibold">ks_rachel</h3>
                <p class="text-sm text-zinc-400">Random loadout via channel points. Clip below.</p>
            </div>
            <div class="hidden sm:flex gap-2">
                <a href="https://twitch.tv/ks_rachel" class="rounded-xl bg-emerald-500 px-3 py-2 font-semibold text-black hover:bg-emerald-400">Watch</a>
                <a href="/spotlight/ks_rachel" class="rounded-xl border border-zinc-700 px-3 py-2 font-semibold hover:bg-zinc-800">Profile</a>
            </div>
        </div>

        <!-- Click to load the embed -->
        <div class="mt-4 overflow-hidden rounded-xl border border-zinc-800">
            <button id="load-spotlight-clip" class="block w-full aspect-video text-zinc-300 bg-[url('/images/streamers/ks_rachel_thumb.jpg')] bg-cover bg-center">
                <span class="sr-only">Play clip</span>
            </button>
        </div>

        <div class="mt-3 sm:hidden flex gap-2">
            <a href="https://twitch.tv/ks_rachel" class="flex-1 rounded-xl bg-emerald-500 px-3 py-2 text-center font-semibold text-black">Watch</a>
            <a href="/spotlight/ks_rachel" class="flex-1 rounded-xl border border-zinc-700 px-3 py-2 text-center font-semibold">Profile</a>
        </div>
    </section>

    <script>
        const btn = document.getElementById('load-spotlight-clip');
        if (btn) {
            btn.addEventListener('click', () => {
                const parent = btn.parentElement;
                parent.innerHTML = `
                    <iframe
                        class="w-full h-[56vw] max-h-[540px]"
                        src="https://clips.twitch.tv/embed?clip=REPLACE_CLIP_ID&parent=thefinalsloadout.com"
                        allowfullscreen
                        loading="lazy">
                    </iframe>`;
            });
        }
    </script>

    <!-- Footer -->
    <footer>
        <div class="support-section">
            <div style="display:flex;align-items:center;justify-content:center;gap:1rem;flex-wrap:wrap;">
                <span style="font-size:1.5rem;">☕</span>
                <div>
                    <p style="margin:0;color:#50c878;font-weight:600;font-size:0.9rem;">Enjoying the premium slot machine?</p>
                    <p style="margin:0.25rem 0 0.75rem 0;color:#b8bfc6;font-size:0.8rem;">Help keep it running with a coffee!</p>
                </div>
            </div>
            <a href="https://ko-fi.com/nextroundonme" target="_blank" rel="noopener" class="support-btn">
                <span>💚 Support Me</span>
            </a>
        </div>
        
        <p style="margin:0 0 0.5rem 0;">
            © 2025 TheFinalsLoadout.com | Created by 
            <a href="https://www.paultakisaki.com/" rel="author" style="color:#00f0c0;text-decoration:none;">Paul Takisaki</a>
        </p>
        <div style="display:flex;justify-content:center;gap:2rem;flex-wrap:wrap;font-size:0.75rem;margin-top:0.5rem;">
            <a href="/legal/" style="color:#00f0c0;text-decoration:none;">Legal Disclaimer</a>
            <a href="https://thefinalsloadout.com/feedback" style="color:#ffd700;text-decoration:none;">📝 Submit Feedback</a>
        </div>
    </footer>
    
    <!-- History Management Script -->
    <script>
        // Hamburger Menu Toggle
        document.addEventListener('DOMContentLoaded', function() {
            const hamburger = document.querySelector('.hamburger');
            const navLinks = document.querySelector('.nav-links');
            
            if (hamburger && navLinks) {
                let menuOpen = false;
                
                hamburger.addEventListener('click', function(e) {
                    e.stopPropagation();
                    menuOpen = !menuOpen;
                    
                    // Direct style manipulation using transform
                    navLinks.style.transform = menuOpen ? 'translateX(100%)' : 'translateX(0)';
                    hamburger.classList.toggle('active', menuOpen);
                    document.body.classList.toggle('menu-open', menuOpen);
                    
                    // Debug - log to console
                    console.log('Menu clicked, open:', menuOpen);
                    console.log('Nav links element:', navLinks);
                    console.log('Transform applied:', navLinks.style.transform);
                    
                    // Update ARIA expanded state
                    hamburger.setAttribute('aria-expanded', menuOpen);
                });
                
                // Close menu when clicking a link
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', function() {
                        menuOpen = false;
                        navLinks.style.transform = 'translateX(0)';
                        hamburger.classList.remove('active');
                        document.body.classList.remove('menu-open');
                        hamburger.setAttribute('aria-expanded', 'false');
                    });
                });
                
                // Close menu when clicking outside
                document.addEventListener('click', function(e) {
                    if (menuOpen && !hamburger.contains(e.target) && !navLinks.contains(e.target)) {
                        menuOpen = false;
                        navLinks.style.transform = 'translateX(0)';
                        hamburger.classList.remove('active');
                        document.body.classList.remove('menu-open');
                        hamburger.setAttribute('aria-expanded', 'false');
                    }
                });
            }
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Space key to spin (prevent default page scroll)
                if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    const spinButton = document.getElementById('spinButton');
                    if (spinButton && !spinButton.disabled) {
                        spinButton.click();
                    }
                }
                
                // F key to open filters
                if ((e.key === 'f' || e.key === 'F') && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    const filterButton = document.getElementById('secondary-filter-button');
                    if (filterButton) {
                        filterButton.click();
                    }
                }
            });
            
            // Share button functionality
            const shareButton = document.getElementById('shareLoadout');
            if (shareButton) {
                shareButton.addEventListener('click', function() {
                    shareLoadout();
                });
            }
        });
        
        // Store current loadout globally for sharing
        window.currentLoadout = null;
        
        // Function to show share button after spin
        function showShareButton(loadout) {
            window.currentLoadout = loadout;
            const shareSection = document.getElementById('shareSection');
            if (shareSection) {
                shareSection.style.display = 'block';
            }
        }
        
        // Share loadout function
        function shareLoadout() {
            if (!window.currentLoadout) return;
            
            const loadout = window.currentLoadout;
            const logoUrl = 'https://www.thefinalsloadout.com/images/logo%20final.webp';
            const siteUrl = 'https://www.thefinalsloadout.com';
            
            // Create share text
            const shareText = `🎰 THE FINALS LOADOUT\n\n` +
                `Class: ${loadout.class || 'Unknown'}\n` +
                `Weapon: ${loadout.weapon || 'Unknown'}\n` +
                `Specialization: ${loadout.specialization || 'Unknown'}\n` +
                `Gadget 1: ${loadout.gadget1 || 'Unknown'}\n` +
                `Gadget 2: ${loadout.gadget2 || 'Unknown'}\n` +
                `Gadget 3: ${loadout.gadget3 || 'Unknown'}\n\n` +
                `Generate your own at: ${siteUrl}`;
            
            // Check if Web Share API is available
            if (navigator.share) {
                navigator.share({
                    title: 'My Finals Loadout',
                    text: shareText,
                    url: siteUrl
                }).catch(err => {
                    // Fallback to clipboard
                    copyToClipboard(shareText);
                });
            } else {
                // Fallback to clipboard
                copyToClipboard(shareText);
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const button = document.getElementById('shareLoadout');
                const originalText = button.innerHTML;
                button.innerHTML = '✓ Copied to Clipboard!';
                button.style.background = 'linear-gradient(135deg, #50c878, #2e8b57)';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                }, 2000);
            });
        }

        class LoadoutHistory {
            constructor() {
                this.maxHistory = 5;
                this.historyKey = 'premiumSlotHistory';
                this.init();
            }
            
            init() {
                this.loadHistory();
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                // Clear history button
                const clearBtn = document.getElementById('clearHistoryBtn');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => this.clearHistory());
                }
            }
            
            loadHistory() {
                const saved = localStorage.getItem(this.historyKey);
                this.history = saved ? JSON.parse(saved) : [];
                this.render();
            }
            
            addLoadout(loadout) {
                if (!loadout) return;
                
                // Add timestamp and unique ID
                const entry = {
                    ...loadout,
                    id: Date.now(),
                    timestamp: new Date().toLocaleTimeString()
                };
                
                // Add to beginning and limit to maxHistory
                this.history.unshift(entry);
                if (this.history.length > this.maxHistory) {
                    this.history = this.history.slice(0, this.maxHistory);
                }
                
                // Save and render
                this.saveHistory();
                this.render();
            }
            
            saveHistory() {
                localStorage.setItem(this.historyKey, JSON.stringify(this.history));
            }
            
            clearHistory() {
                if (confirm('Clear all loadout history?')) {
                    this.history = [];
                    this.saveHistory();
                    this.render();
                }
            }
            
            copyLoadout(loadout) {
                const text = `Class: ${loadout.class || 'Unknown'}
Weapon: ${loadout.weapon}
Specialization: ${loadout.specialization}
Gadget 1: ${loadout.gadget1}
Gadget 2: ${loadout.gadget2}
Gadget 3: ${loadout.gadget3}`;
                
                navigator.clipboard.writeText(text).then(() => {
                    // Show copied feedback
                    event.target.classList.add('copied');
                    event.target.textContent = '✓ Copied!';
                    setTimeout(() => {
                        event.target.classList.remove('copied');
                        event.target.textContent = '📋 Copy';
                    }, 2000);
                });
            }
            
            render() {
                const container = document.getElementById('historyList');
                const count = document.getElementById('historyCount');
                
                if (!container) return;
                
                // Update count
                if (count) {
                    count.textContent = `(${this.history.length})`;
                }
                
                // Render history items
                if (this.history.length === 0) {
                    container.innerHTML = '<div class="empty-history">No loadouts generated yet. Spin the slots to get started!</div>';
                } else {
                    container.innerHTML = this.history.map(item => `
                        <div class="history-item">
                            <div class="loadout-details">
                                <div class="loadout-class">${item.class || 'Unknown'}</div>
                                <div class="loadout-equipment">
                                    <div class="equipment-item">
                                        <span class="equipment-label">Weapon</span>
                                        <span class="equipment-value">${item.weapon}</span>
                                    </div>
                                    <div class="equipment-item">
                                        <span class="equipment-label">Spec</span>
                                        <span class="equipment-value">${item.specialization}</span>
                                    </div>
                                    <div class="equipment-item">
                                        <span class="equipment-label">Gadget 1</span>
                                        <span class="equipment-value">${item.gadget1}</span>
                                    </div>
                                    <div class="equipment-item">
                                        <span class="equipment-label">Gadget 2</span>
                                        <span class="equipment-value">${item.gadget2}</span>
                                    </div>
                                    <div class="equipment-item">
                                        <span class="equipment-label">Gadget 3</span>
                                        <span class="equipment-value">${item.gadget3}</span>
                                    </div>
                                </div>
                            </div>
                            <button class="copy-btn" data-id="${item.id}">📋 Copy</button>
                        </div>
                    `).join('');
                    
                    // Add copy event listeners
                    container.querySelectorAll('.copy-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = parseInt(e.target.dataset.id);
                            const loadout = this.history.find(h => h.id === id);
                            if (loadout) this.copyLoadout(loadout);
                        });
                    });
                }
            }
        }
        
        // Initialize history manager
        window.loadoutHistory = new LoadoutHistory();

        // The premium-integrated.js already handles adding to history in startSlotMachine
        // No need for additional hooks here
    </script>
    
    <!-- Filter System Script -->
    <script>
        class FilterSystem {
            constructor() {
                this.filterState = {};
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.loadFilterState();
                
                // Wait for premium integrated to be ready
                const checkReady = setInterval(() => {
                    if (window.premiumIntegrated && window.premiumIntegrated.loadoutData) {
                        clearInterval(checkReady);
                        this.populateFilters();
                    }
                }, 100);
            }
            
            setupEventListeners() {
                // Secondary filter button - prominent placement
                const secondaryBtn = document.getElementById('secondary-filter-button');
                if (secondaryBtn) {
                    secondaryBtn.addEventListener('click', () => {
                        this.togglePanel();
                        // Remove pulse animation after first click
                        secondaryBtn.classList.add('clicked');
                    });
                }
                
                // Close button
                const closeBtn = document.getElementById('close-filter-panel');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.closePanel());
                }
                
                // Overlay click
                const overlay = document.getElementById('filter-panel-overlay');
                if (overlay) {
                    overlay.addEventListener('click', () => this.closePanel());
                }
                
                // Apply button
                const applyBtn = document.getElementById('apply-filters');
                if (applyBtn) {
                    applyBtn.addEventListener('click', () => this.applyFilters());
                }
                
                // Clear button
                const clearBtn = document.getElementById('clear-filters');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => this.clearAllFilters());
                }
                
                // Reset All Filters button
                const resetBtn = document.getElementById('reset-all-filters');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        this.clearAllFilters();
                        this.applyFilters();
                        this.closePanel();
                    });
                }
            }
            
            togglePanel() {
                const panel = document.getElementById('filter-panel');
                const overlay = document.getElementById('filter-panel-overlay');
                
                if (panel && overlay) {
                    const isActive = panel.classList.contains('active');
                    if (isActive) {
                        this.closePanel();
                    } else {
                        panel.classList.add('active');
                        overlay.classList.add('active');
                    }
                }
            }
            
            closePanel() {
                const panel = document.getElementById('filter-panel');
                const overlay = document.getElementById('filter-panel-overlay');
                
                if (panel && overlay) {
                    panel.classList.remove('active');
                    overlay.classList.remove('active');
                }
            }
            
            populateFilters() {
                const container = document.getElementById('filter-content');
                if (!container || !window.premiumIntegrated) return;
                
                const data = window.premiumIntegrated.getGameData();
                if (!data) return;
                
                container.innerHTML = '';
                
                ['Light', 'Medium', 'Heavy'].forEach(className => {
                    const section = document.createElement('div');
                    section.className = 'filter-section';
                    section.innerHTML = `<h3 class="filter-class-title">${className} Class</h3>`;
                    
                    // Weapons
                    const weaponsDiv = this.createFilterCategory('Weapons', data[className].weapons, className, 'weapon');
                    section.appendChild(weaponsDiv);
                    
                    // Specializations
                    const specsDiv = this.createFilterCategory('Specializations', data[className].specializations, className, 'specialization');
                    section.appendChild(specsDiv);
                    
                    // Gadgets
                    const gadgetsDiv = this.createFilterCategory('Gadgets', data[className].gadgets, className, 'gadget');
                    section.appendChild(gadgetsDiv);
                    
                    container.appendChild(section);
                });
            }
            
            createFilterCategory(title, items, className, type) {
                const div = document.createElement('div');
                div.className = 'filter-category';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'filter-category-title';
                titleDiv.innerHTML = `
                    <span>${title}</span>
                    <label class="select-all-checkbox">
                        <input type="checkbox" data-class="${className}" data-type="${type}" data-select-all="true" checked>
                        <span>Select All</span>
                    </label>
                `;
                div.appendChild(titleDiv);
                
                const itemsDiv = document.createElement('div');
                itemsDiv.className = 'filter-items';
                
                items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'filter-item';
                    itemDiv.innerHTML = `
                        <input type="checkbox" id="${className}-${type}-${item}" 
                               data-class="${className}" 
                               data-type="${type}" 
                               value="${item}" 
                               checked>
                        <label for="${className}-${type}-${item}">${item}</label>
                    `;
                    itemsDiv.appendChild(itemDiv);
                });
                
                div.appendChild(itemsDiv);
                
                // Setup select all functionality
                const selectAll = titleDiv.querySelector('[data-select-all]');
                if (selectAll) {
                    selectAll.addEventListener('change', (e) => {
                        const checkboxes = itemsDiv.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(cb => cb.checked = e.target.checked);
                    });
                }
                
                // Update select all when individual items change
                itemsDiv.addEventListener('change', () => {
                    const total = itemsDiv.querySelectorAll('input[type="checkbox"]').length;
                    const checked = itemsDiv.querySelectorAll('input[type="checkbox"]:checked').length;
                    if (selectAll) {
                        selectAll.checked = checked === total;
                        selectAll.indeterminate = checked > 0 && checked < total;
                    }
                });
                
                return div;
            }
            
            applyFilters() {
                if (!window.premiumIntegrated) return;
                
                const filterState = {
                    Light: { weapons: [], specializations: [], gadgets: [] },
                    Medium: { weapons: [], specializations: [], gadgets: [] },
                    Heavy: { weapons: [], specializations: [], gadgets: [] }
                };
                
                // Get all unchecked items (these will be filtered out)
                const uncheckedBoxes = document.querySelectorAll('#filter-content input[type="checkbox"]:not(:checked):not([data-select-all])');
                
                // Update filter count badge
                const filterCount = uncheckedBoxes.length;
                const badge = document.getElementById('filter-count-badge');
                if (badge) {
                    if (filterCount > 0) {
                        badge.textContent = filterCount;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
                
                uncheckedBoxes.forEach(checkbox => {
                    const className = checkbox.dataset.class;
                    const type = checkbox.dataset.type;
                    const value = checkbox.value;
                    
                    if (type === 'weapon') {
                        filterState[className].weapons.push(value);
                    } else if (type === 'specialization') {
                        filterState[className].specializations.push(value);
                    } else if (type === 'gadget') {
                        filterState[className].gadgets.push(value);
                    }
                });
                
                // Validate filters
                const errors = this.validateFilters(filterState);
                if (errors.length > 0) {
                    alert('Filter validation failed:\n\n' + errors.join('\n'));
                    return;
                }
                
                // Apply filters
                window.premiumIntegrated.filterState = filterState;
                window.premiumIntegrated.saveFilterState();
                
                this.closePanel();
                
                // Show confirmation
                this.showToast('Filters applied successfully!');
            }
            
            validateFilters(filterState) {
                const errors = [];
                const data = window.premiumIntegrated.getGameData();
                
                ['Light', 'Medium', 'Heavy'].forEach(className => {
                    const classData = data[className];
                    const filters = filterState[className];
                    
                    // Check weapons
                    const availableWeapons = classData.weapons.filter(w => !filters.weapons.includes(w));
                    if (availableWeapons.length === 0) {
                        errors.push(`${className}: At least 1 weapon must be available`);
                    }
                    
                    // Check specializations
                    const availableSpecs = classData.specializations.filter(s => !filters.specializations.includes(s));
                    if (availableSpecs.length === 0) {
                        errors.push(`${className}: At least 1 specialization must be available`);
                    }
                    
                    // Check gadgets
                    const availableGadgets = classData.gadgets.filter(g => !filters.gadgets.includes(g));
                    if (availableGadgets.length < 3) {
                        errors.push(`${className}: At least 3 gadgets must be available`);
                    }
                });
                
                return errors;
            }
            
            clearAllFilters() {
                const checkboxes = document.querySelectorAll('#filter-content input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = true);
                
                // Clear the filter count badge
                const badge = document.getElementById('filter-count-badge');
                if (badge) {
                    badge.style.display = 'none';
                }
                
                if (window.premiumIntegrated) {
                    window.premiumIntegrated.filterState = {
                        Light: { weapons: [], specializations: [], gadgets: [] },
                        Medium: { weapons: [], specializations: [], gadgets: [] },
                        Heavy: { weapons: [], specializations: [], gadgets: [] }
                    };
                    window.premiumIntegrated.saveFilterState();
                }
                
                this.showToast('All filters cleared!');
            }
            
            loadFilterState() {
                if (!window.premiumIntegrated) return;
                
                const filterState = window.premiumIntegrated.filterState;
                if (!filterState) return;
                
                // Apply saved filter state to checkboxes
                Object.keys(filterState).forEach(className => {
                    const classFilters = filterState[className];
                    
                    // Uncheck filtered items
                    classFilters.weapons.forEach(item => {
                        const checkbox = document.querySelector(`#${className}-weapon-${item}`);
                        if (checkbox) checkbox.checked = false;
                    });
                    
                    classFilters.specializations.forEach(item => {
                        const checkbox = document.querySelector(`#${className}-specialization-${item}`);
                        if (checkbox) checkbox.checked = false;
                    });
                    
                    classFilters.gadgets.forEach(item => {
                        const checkbox = document.querySelector(`#${className}-gadget-${item}`);
                        if (checkbox) checkbox.checked = false;
                    });
                });
            }
            
            showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'filter-toast';
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 240, 192, 0.9);
                    color: #000;
                    padding: 1rem 2rem;
                    border-radius: 8px;
                    font-weight: 600;
                    z-index: 2000;
                    animation: slideUp 0.3s ease;
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideDown 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            }
        }
        
        // Add toast animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideUp {
                from { transform: translate(-50%, 100%); opacity: 0; }
                to { transform: translate(-50%, 0); opacity: 1; }
            }
            @keyframes slideDown {
                from { transform: translate(-50%, 0); opacity: 1; }
                to { transform: translate(-50%, 100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Initialize filter system
        window.filterSystem = new FilterSystem();
        
        // Scroll Progress Bar
        function updateScrollProgress() {
            const scrollTop = window.scrollY;
            const documentHeight = document.documentElement.scrollHeight - window.innerHeight;
            const scrollPercentage = documentHeight > 0 ? (scrollTop / documentHeight) * 100 : 0;
            const progressBar = document.getElementById('scrollProgress');
            if (progressBar) {
                progressBar.style.width = Math.min(scrollPercentage, 100) + '%';
            }
        }

        // Update on scroll
        window.addEventListener('scroll', updateScrollProgress);
        // Update on resize
        window.addEventListener('resize', updateScrollProgress);
        // Initial update
        document.addEventListener('DOMContentLoaded', updateScrollProgress);
    </script>

    <!-- Supabase Integration for OBS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://vdwkgrgacwxjnofglbyn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkd2tncmdhY3d4am5vZmdsYnluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMTU5MjcsImV4cCI6MjA3Mzg5MTkyN30.7EsHGeSQG2ueT_ydwjKMYoAHz9O_wIK5d79SsRBWmMc';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Generate or get unique channel ID for this user
        function getMyChannelId() {
            let channelId = localStorage.getItem('myStreamChannelId');
            if (!channelId) {
                // Generate a unique ID for this browser/streamer
                channelId = 'stream_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('myStreamChannelId', channelId);
            }
            return channelId;
        }

        // Get the channel ID and display it
        const myChannelId = getMyChannelId();
        console.log('Your unique channel ID:', myChannelId);

        // Update the overlay URL to include the channel
        function updateOverlayUrlWithChannel() {
            const urlInput = document.getElementById('quickOverlayUrl');
            if (urlInput) {
                // Use the current domain, not localhost
                const baseUrl = window.location.origin;
                urlInput.value = `${baseUrl}/overlay/?channel=${myChannelId}`;
            }
        }

        // Call this when the page loads
        document.addEventListener('DOMContentLoaded', updateOverlayUrlWithChannel);

        // Create channel once and reuse it
        const channelName = 'overlay_' + myChannelId;
        let overlayChannel = null;
        let isSubscribed = false;

        // Initialize the channel
        function initChannel() {
            if (!overlayChannel) {
                overlayChannel = supabase.channel(channelName);
                overlayChannel.subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        isSubscribed = true;
                        console.log(`✅ Connected to channel: ${channelName}`);
                    }
                });
            }
            return overlayChannel;
        }

        // Initialize on page load
        initChannel();

        // Send loadout via Supabase
        function sendLoadoutSupabase(overlayData) {
            const channel = initChannel();

            // Store as currentLoadout for stream-tools to pick up
            localStorage.setItem('currentLoadout', JSON.stringify(overlayData));

            // Send immediately if already subscribed, or wait for subscription
            if (isSubscribed) {
                channel.send({
                    type: 'broadcast',
                    event: 'loadout_update',
                    payload: overlayData
                });
                console.log(`✅ Sent loadout via Supabase on channel: ${channelName}`);

                // ALSO send to obs_default channel for OBS
                const obsDefaultChannel = supabase.channel('obs_default');
                obsDefaultChannel.subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        obsDefaultChannel.send({
                            type: 'broadcast',
                            event: 'loadout_update',
                            payload: overlayData
                        });
                        console.log(`✅ Also sent to OBS default channel`);
                        setTimeout(() => obsDefaultChannel.unsubscribe(), 100);
                    }
                });

                showQuickStatus('✅ Sent to OBS!', true);
            } else {
                // Wait for subscription then send
                const checkSubscription = setInterval(() => {
                    if (isSubscribed) {
                        clearInterval(checkSubscription);
                        channel.send({
                            type: 'broadcast',
                            event: 'loadout_update',
                            payload: overlayData
                        });
                        console.log(`✅ Sent loadout via Supabase on channel: ${channelName}`);

                        // ALSO send to obs_default channel for OBS
                        const obsDefaultChannel = supabase.channel('obs_default');
                        obsDefaultChannel.subscribe((status) => {
                            if (status === 'SUBSCRIBED') {
                                obsDefaultChannel.send({
                                    type: 'broadcast',
                                    event: 'loadout_update',
                                    payload: overlayData
                                });
                                console.log(`✅ Also sent to OBS default channel`);
                                setTimeout(() => obsDefaultChannel.unsubscribe(), 100);
                            }
                        });

                        showQuickStatus('✅ Sent to OBS!', true);
                    }
                }, 100);

                // Timeout after 5 seconds
                setTimeout(() => {
                    clearInterval(checkSubscription);
                    if (!isSubscribed) {
                        console.error('Failed to connect to Supabase');
                        showQuickStatus('⚠️ Connection issue, please refresh', false);
                    }
                }, 5000);
            }
        }
    </script>

    <!-- Performance Optimizations -->
    <script src="/js/optimizations.js"></script>

    <!-- Audio Elements for Slot Machine Sounds -->
    <audio id="clickSound" src="sounds/click.mp3" preload="auto"></audio>
</body>
</html>