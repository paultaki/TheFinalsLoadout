<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="canonical" href="https://www.thefinalsloadout.com/" />

    <!-- Performance Hints -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link rel="dns-prefetch" href="https://static.cloudflareinsights.com" />

    <!-- Preload Critical Resources - Logo is LCP element -->
    <!-- Removed unused preload: <link rel="preload" href="/images/the-finals-logo.webp" as="image" type="image/webp" fetchpriority="high" /> -->

    <!-- Meta Tags -->
    <title>The Finals BEST Random Loadout Generator | Fun & Unique Loadouts</title>
    <meta name="description" content="Get the best random loadouts for The Finals game to have fun and be challenged. Find new weapon builds for Light, Medium, and Heavy playstyles." />
    <meta name="author" content="Paul Takisaki" />
    <link rel="author" href="https://www.paultakisaki.com/" />

    <!-- Open Graph -->
    <meta property="og:title" content="The Finals Loadout Roulette" />
    <meta property="og:description" content="Randomize your loadout and dominate The Finals with style." />
    <meta property="og:image" content="https://www.thefinalsloadout.com/wt-progress/images/social1200x630.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:url" content="https://www.thefinalsloadout.com/" />
    <meta property="og:type" content="website" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="The Finals Loadout Roulette" />
    <meta name="twitter:description" content="Spin the wheel. Wreck the arena." />
    <meta name="twitter:image" content="https://www.thefinalsloadout.com/wt-progress/images/social1200x630.png" />

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "The Finals Loadout Generator",
        "url": "https://www.thefinalsloadout.com",
        "description": "A random loadout generator for The Finals game with optimized weapons and gadgets for different playstyles.",
        "image": "https://www.thefinalsloadout.com/images/the-finals-logo.webp",
        "author": {
            "@type": "Person",
            "name": "Paul Takisaki",
            "url": "https://www.paultakisaki.com"
        }
    }
    </script>

    <!-- Fonts - Optimized Loading (Non-blocking) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <!-- Load fonts asynchronously to prevent render blocking -->
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;900&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;900&display=swap" media="print" onload="this.media='all'; this.onload=null;">
    <noscript>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;900&display=swap">
    </noscript>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />

    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GVGKYFGZ1Z"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {
            dataLayer.push(arguments);
        }
        gtag("js", new Date());
        gtag("config", "G-GVGKYFGZ1Z");
    </script>

    <!-- Console noise control for production -->
    <script>
        window.DEBUG = false;
        if (!window.DEBUG) {
            console.log = function() {};
            console.debug = function() {};
        }
    </script>
    
    <!-- Premium Styles - Extracted for Performance -->
    <link rel="stylesheet" href="/premium-styles.css">
    
    <style>
        /* Critical inline styles for immediate render - rest in premium-styles.css */
        body { background: #0a0a0a; color: #fff; font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
    <!-- Scroll Progress Bar -->
    <div class="scroll-progress-container">
        <div class="scroll-progress-bar" id="scrollProgress"></div>
    </div>
    
    <!-- Simple Working Mobile Menu -->
    <style>
        /* Hide mobile menu button on desktop */
        @media (min-width: 769px) {
            #menuBtn, #simpleMenu, #menuOverlay {
                display: none !important;
            }
        }
        
        /* Mobile styles */
        @media (max-width: 768px) {
            /* Hide desktop nav on mobile */
            .desktop-nav {
                display: none !important;
            }
            #simpleMenu {
                position: fixed;
                top: 0;
                left: -280px;
                width: 280px;
                height: 100vh;
                background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
                z-index: 99999;
                transition: left 0.3s ease;
                padding-top: 60px;
                box-shadow: 5px 0 20px rgba(0,0,0,0.7);
                border-right: 2px solid rgba(255, 51, 102, 0.3);
            }
            #simpleMenu.show {
                left: 0;
            }
            #simpleMenu a:hover {
                background: rgba(255, 51, 102, 0.1);
                padding-left: 25px;
            }
            #menuBtn {
                position: fixed;
                top: 10px;
                left: 10px;
                z-index: 100000;
                background: rgba(26, 26, 26, 0.95);
                color: #ff3366;
                border: 1px solid rgba(255, 51, 102, 0.3);
                border-radius: 8px;
                padding: 10px 12px;
                cursor: pointer;
                font-size: 20px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                transition: all 0.3s;
            }
            #menuBtn:hover {
                background: rgba(255, 51, 102, 0.1);
                transform: scale(1.1);
            }
            
            /* Dark overlay */
            #menuOverlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 99998;
                display: none;
            }
            #menuOverlay.show {
                display: block;
            }
        }
    </style>
    
    <button id="menuBtn" onclick="document.getElementById('simpleMenu').classList.toggle('show'); document.getElementById('menuOverlay').classList.toggle('show')">☰</button>
    
    <div id="menuOverlay" onclick="document.getElementById('simpleMenu').classList.remove('show'); this.classList.remove('show')"></div>
    
    <div id="simpleMenu">
        <a href="/v3/" style="display:block;color:white;padding:15px;border-bottom:1px solid #333;text-decoration:none;transition:all 0.3s;">LOADOUT GENERATOR</a>
        <a href="/ragequit/" style="display:block;color:white;padding:15px;border-bottom:1px solid #333;text-decoration:none;transition:all 0.3s;">RAGE QUIT</a>
        <a href="/patch-notes/" style="display:block;color:white;padding:15px;border-bottom:1px solid #333;text-decoration:none;transition:all 0.3s;">PATCH NOTES</a>
        <a href="/meta-weapons/" style="display:block;color:white;padding:15px;border-bottom:1px solid #333;text-decoration:none;transition:all 0.3s;">META WEAPONS</a>
        <a href="/wt-progress/" style="display:block;color:white;padding:15px;border-bottom:1px solid #333;text-decoration:none;transition:all 0.3s;">WORLD TOUR</a>
    </div>
    
    <!-- Navigation Bar (Desktop) -->
    <nav class="main-nav desktop-nav">
        <div class="nav-links desktop-nav-links">
            <a href="/v3/" class="nav-link active">LOADOUT GENERATOR</a>
            <a href="/ragequit/" class="nav-link">RAGE QUIT</a>
            <a href="/patch-notes/" class="nav-link">PATCH NOTES</a>
            <a href="/meta-weapons/" class="nav-link">META WEAPONS</a>
            <a href="/wt-progress/" class="nav-link">WORLD TOUR</a>
        </div>
    </nav>

    <!-- Header -->
    <header class="header">
        <!-- Logo image - easy to revert by uncommenting text below and removing img -->
        <img src="/images/logo final.webp" alt="The Finals Premium Slot Machine" class="header-logo">
        <!-- Previous logos: 
        <img src="/images/logo-header.webp" alt="The Finals Premium Slot Machine" class="header-logo">
        <img src="/images/logo-header-v2.webp" alt="The Finals Premium Slot Machine" class="header-logo"> 
        -->
        <!-- Original text header (backup) - uncomment to restore:
        <h1 class="title">THE FINALS</h1>
        <h1 class="title">PREMIUM SLOT MACHINE</h1>
        <p class="subtitle">Vegas-Style Loadout Generator</p>
        -->
        
        <!-- Season 8 Badge -->
        <div class="season-badge">
            <span class="season-text">🎯 Season 8 Ready!</span>
            <span class="season-subtext">BFR Titan & P90 Added</span>
        </div>
        
        <!-- Thank You Note (auto-hides after 72 hours) -->
        <div id="thankYouNote" style="text-align: center; margin-top: 8px; margin-bottom: 10px; display: none;">
            <p style="font-size: 0.85em; color: #888; font-style: italic; margin: 0;">
                Thanks for reporting the filtering issue. If you see anymore bugs or have suggestions drop me a note on the 
                <a href="/feedback" style="color: #aaa; text-decoration: underline;">feedback</a> page.
            </p>
        </div>
        
        <script>
        // Auto-hide thank you note after 72 hours
        (function() {
            const noteElement = document.getElementById('thankYouNote');
            const noteAddedTime = new Date('2025-01-12T00:00:00').getTime(); // Today's date
            const currentTime = new Date().getTime();
            const hoursPassed = (currentTime - noteAddedTime) / (1000 * 60 * 60);
            
            if (hoursPassed < 72) {
                noteElement.style.display = 'block';
            }
        })();
        </script>
    </header>

    <!-- Premium Slot Machine Container -->
    <div class="slot-machine-premium">
        <!-- Controls Section -->
        <div class="controls-section">
            <!-- Random Everything Button -->
            <button class="random-all-premium" id="randomAllBtn">
                <span class="dice-icon">🎲</span>
                <span>RANDOM EVERYTHING</span>
            </button>

            <!-- Secondary Filter Button - More prominent placement -->
            <button id="secondary-filter-button" class="secondary-filter-button" aria-label="Customize filters">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="4" y1="6" x2="20" y2="6"></line>
                    <line x1="4" y1="12" x2="20" y2="12"></line>
                    <line x1="4" y1="18" x2="20" y2="18"></line>
                    <circle cx="7" cy="6" r="2" fill="currentColor"></circle>
                    <circle cx="17" cy="12" r="2" fill="currentColor"></circle>
                    <circle cx="10" cy="18" r="2" fill="currentColor"></circle>
                </svg>
                <span>Customize Filters</span>
                <span class="filter-count-badge" id="filter-count-badge" style="display: none;">0</span>
            </button>

            <!-- Selection Grid -->
            <div class="selection-grid">
                <!-- Spin Selection -->
                <div class="selection-panel">
                    <div class="selection-title">Select # of Spins</div>
                    <div class="selection-options">
                        <button class="select-btn spin-btn" data-spins="1">1</button>
                        <button class="select-btn spin-btn" data-spins="2">2</button>
                        <button class="select-btn spin-btn" data-spins="3">3</button>
                        <button class="select-btn spin-btn" data-spins="4">4</button>
                        <button class="select-btn spin-btn" data-spins="5">5</button>
                    </div>
                </div>

                <!-- Class Selection -->
                <div class="selection-panel">
                    <div class="selection-title">Select Your Class</div>
                    <div class="selection-options">
                        <button class="select-btn class-btn-premium" data-class="light">
                            <span class="class-icon-premium">⚡</span>
                            <span>LIGHT</span>
                        </button>
                        <button class="select-btn class-btn-premium" data-class="medium">
                            <span class="class-icon-premium">⚔️</span>
                            <span>MEDIUM</span>
                        </button>
                        <button class="select-btn class-btn-premium" data-class="heavy">
                            <span class="class-icon-premium">🛡️</span>
                            <span>HEAVY</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slot Display Area -->
        <div class="slot-display" id="slotDisplay">
            <div class="spin-counter" id="spinCounter" style="display: none;">
                SPIN <span id="currentSpin">1</span> OF <span id="totalSpins">3</span>
            </div>

            <!-- Slot Columns -->
            <div class="slot-columns" id="premiumSlotColumns">
                <!-- Columns will be dynamically generated -->
            </div>
        </div>

        <!-- Generate Button -->
        <button class="generate-button" id="generateBtn" disabled>
            SELECT OPTIONS ABOVE
        </button>
    </div>

    <!-- Victory Sparks Container -->
    <div class="victory-sparks" id="victorySparks"></div>

    <!-- Hidden container for app initialization -->
    <div id="slot-machine-container" style="display: none;">
        <!-- The app needs this container to initialize -->
    </div>

    <!-- Load the main app scripts -->
    <script src="app-optimized.js?v=20250831-filter-fix"></script>
    
    <!-- Load the premium integration -->
    <script src="/v3/premium-integrated.js?v=20250831"></script>
    
    <!-- Victory Sparks positioning fix -->
    <script>
        // Fix sparks container positioning
        window.addEventListener('DOMContentLoaded', () => {
            const sparksContainer = document.getElementById('victorySparks');
            if (sparksContainer) {
                // Move it inside the slot display area
                const slotDisplay = document.getElementById('slotDisplay');
                if (slotDisplay) {
                    slotDisplay.appendChild(sparksContainer);
                    sparksContainer.style.position = 'absolute';
                    sparksContainer.style.top = '50%';
                    sparksContainer.style.left = '50%';
                    sparksContainer.style.transform = 'translate(-50%, -50%)';
                    sparksContainer.style.pointerEvents = 'none';
                    sparksContainer.style.zIndex = '1000';
                }
            }
        });
    </script>
    
    <!-- Victory Sparks Container -->
    <div id="victorySparks"></div>
    
    <!-- Share Loadout Section -->
    <div id="shareSection" class="share-section" style="display: none;">
        <button id="shareLoadout" class="share-button">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                <polyline points="16 6 12 2 8 6"></polyline>
                <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg>
            Share This Loadout
        </button>
    </div>
    
    <!-- Filter Panel -->
    <div class="filter-panel-overlay" id="filter-panel-overlay"></div>
    <div class="filter-panel" id="filter-panel">
        <div class="filter-panel-header">
            <h2 class="filter-panel-title">Filter Equipment</h2>
            <button class="close-filter-panel" id="close-filter-panel">✕</button>
        </div>
        <div id="filter-content">
            <!-- Filter content will be dynamically populated -->
        </div>
        <div class="filter-actions">
            <button class="filter-btn reset-all-filters" id="reset-all-filters">Reset All Filters</button>
            <button class="filter-btn clear-filters" id="clear-filters">Clear</button>
            <button class="filter-btn apply-filters" id="apply-filters">Apply Filters</button>
        </div>
    </div>
    
    <!-- History Section -->
    <section class="history-section">
        <div class="history-container">
            <div class="history-header">
                <h2 class="history-title">
                    <span>🎰</span>
                    <span>Loadout History</span>
                    <span class="history-count" id="historyCount">(0)</span>
                </h2>
                <button class="clear-history-btn" id="clearHistoryBtn">Clear All History</button>
            </div>
            <div class="history-list" id="historyList">
                <div class="empty-history">No loadouts generated yet. Spin the slots to get started!</div>
            </div>
        </div>
    </section>
    
    <!-- Footer -->
    <footer>
        <div class="support-section">
            <div style="display:flex;align-items:center;justify-content:center;gap:1rem;flex-wrap:wrap;">
                <span style="font-size:1.5rem;">☕</span>
                <div>
                    <p style="margin:0;color:#50c878;font-weight:600;font-size:0.9rem;">Enjoying the premium slot machine?</p>
                    <p style="margin:0.25rem 0 0.75rem 0;color:#b8bfc6;font-size:0.8rem;">Help keep it running with a coffee!</p>
                </div>
            </div>
            <a href="https://ko-fi.com/nextroundonme" target="_blank" rel="noopener" class="support-btn">
                <span>💚 Support Me</span>
            </a>
        </div>
        
        <p style="margin:0 0 0.5rem 0;">
            © 2025 TheFinalsLoadout.com | Created by 
            <a href="https://www.paultakisaki.com/" rel="author" style="color:#00f0c0;text-decoration:none;">Paul Takisaki</a>
        </p>
        <div style="display:flex;justify-content:center;gap:2rem;flex-wrap:wrap;font-size:0.75rem;margin-top:0.5rem;">
            <a href="/legal/" style="color:#00f0c0;text-decoration:none;">Legal Disclaimer</a>
            <a href="https://thefinalsloadout.com/feedback" style="color:#ffd700;text-decoration:none;">📝 Submit Feedback</a>
        </div>
    </footer>
    
    <!-- History Management Script -->
    <script>
        // Hamburger Menu Toggle
        document.addEventListener('DOMContentLoaded', function() {
            const hamburger = document.querySelector('.hamburger');
            const navLinks = document.querySelector('.nav-links');
            
            if (hamburger && navLinks) {
                let menuOpen = false;
                
                hamburger.addEventListener('click', function(e) {
                    e.stopPropagation();
                    menuOpen = !menuOpen;
                    
                    // Direct style manipulation using transform
                    navLinks.style.transform = menuOpen ? 'translateX(100%)' : 'translateX(0)';
                    hamburger.classList.toggle('active', menuOpen);
                    document.body.classList.toggle('menu-open', menuOpen);
                    
                    // Debug - log to console
                    console.log('Menu clicked, open:', menuOpen);
                    console.log('Nav links element:', navLinks);
                    console.log('Transform applied:', navLinks.style.transform);
                    
                    // Update ARIA expanded state
                    hamburger.setAttribute('aria-expanded', menuOpen);
                });
                
                // Close menu when clicking a link
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', function() {
                        menuOpen = false;
                        navLinks.style.transform = 'translateX(0)';
                        hamburger.classList.remove('active');
                        document.body.classList.remove('menu-open');
                        hamburger.setAttribute('aria-expanded', 'false');
                    });
                });
                
                // Close menu when clicking outside
                document.addEventListener('click', function(e) {
                    if (menuOpen && !hamburger.contains(e.target) && !navLinks.contains(e.target)) {
                        menuOpen = false;
                        navLinks.style.transform = 'translateX(0)';
                        hamburger.classList.remove('active');
                        document.body.classList.remove('menu-open');
                        hamburger.setAttribute('aria-expanded', 'false');
                    }
                });
            }
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Space key to spin (prevent default page scroll)
                if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    const spinButton = document.getElementById('spinButton');
                    if (spinButton && !spinButton.disabled) {
                        spinButton.click();
                    }
                }
                
                // F key to open filters
                if ((e.key === 'f' || e.key === 'F') && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    const filterButton = document.getElementById('secondary-filter-button');
                    if (filterButton) {
                        filterButton.click();
                    }
                }
            });
            
            // Share button functionality
            const shareButton = document.getElementById('shareLoadout');
            if (shareButton) {
                shareButton.addEventListener('click', function() {
                    shareLoadout();
                });
            }
        });
        
        // Store current loadout globally for sharing
        window.currentLoadout = null;
        
        // Function to show share button after spin
        function showShareButton(loadout) {
            window.currentLoadout = loadout;
            const shareSection = document.getElementById('shareSection');
            if (shareSection) {
                shareSection.style.display = 'block';
            }
        }
        
        // Share loadout function
        function shareLoadout() {
            if (!window.currentLoadout) return;
            
            const loadout = window.currentLoadout;
            const logoUrl = 'https://www.thefinalsloadout.com/images/logo%20final.webp';
            const siteUrl = 'https://www.thefinalsloadout.com';
            
            // Create share text
            const shareText = `🎰 THE FINALS LOADOUT\n\n` +
                `Class: ${loadout.class || 'Unknown'}\n` +
                `Weapon: ${loadout.weapon || 'Unknown'}\n` +
                `Specialization: ${loadout.specialization || 'Unknown'}\n` +
                `Gadget 1: ${loadout.gadget1 || 'Unknown'}\n` +
                `Gadget 2: ${loadout.gadget2 || 'Unknown'}\n` +
                `Gadget 3: ${loadout.gadget3 || 'Unknown'}\n\n` +
                `Generate your own at: ${siteUrl}`;
            
            // Check if Web Share API is available
            if (navigator.share) {
                navigator.share({
                    title: 'My Finals Loadout',
                    text: shareText,
                    url: siteUrl
                }).catch(err => {
                    // Fallback to clipboard
                    copyToClipboard(shareText);
                });
            } else {
                // Fallback to clipboard
                copyToClipboard(shareText);
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const button = document.getElementById('shareLoadout');
                const originalText = button.innerHTML;
                button.innerHTML = '✓ Copied to Clipboard!';
                button.style.background = 'linear-gradient(135deg, #50c878, #2e8b57)';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                }, 2000);
            });
        }

        class LoadoutHistory {
            constructor() {
                this.maxHistory = 5;
                this.historyKey = 'premiumSlotHistory';
                this.init();
            }
            
            init() {
                this.loadHistory();
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                // Clear history button
                const clearBtn = document.getElementById('clearHistoryBtn');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => this.clearHistory());
                }
            }
            
            loadHistory() {
                const saved = localStorage.getItem(this.historyKey);
                this.history = saved ? JSON.parse(saved) : [];
                this.render();
            }
            
            addLoadout(loadout) {
                if (!loadout) return;
                
                // Add timestamp and unique ID
                const entry = {
                    ...loadout,
                    id: Date.now(),
                    timestamp: new Date().toLocaleTimeString()
                };
                
                // Add to beginning and limit to maxHistory
                this.history.unshift(entry);
                if (this.history.length > this.maxHistory) {
                    this.history = this.history.slice(0, this.maxHistory);
                }
                
                // Save and render
                this.saveHistory();
                this.render();
            }
            
            saveHistory() {
                localStorage.setItem(this.historyKey, JSON.stringify(this.history));
            }
            
            clearHistory() {
                if (confirm('Clear all loadout history?')) {
                    this.history = [];
                    this.saveHistory();
                    this.render();
                }
            }
            
            copyLoadout(loadout) {
                const text = `Class: ${loadout.class || 'Unknown'}
Weapon: ${loadout.weapon}
Specialization: ${loadout.specialization}
Gadget 1: ${loadout.gadget1}
Gadget 2: ${loadout.gadget2}
Gadget 3: ${loadout.gadget3}`;
                
                navigator.clipboard.writeText(text).then(() => {
                    // Show copied feedback
                    event.target.classList.add('copied');
                    event.target.textContent = '✓ Copied!';
                    setTimeout(() => {
                        event.target.classList.remove('copied');
                        event.target.textContent = '📋 Copy';
                    }, 2000);
                });
            }
            
            render() {
                const container = document.getElementById('historyList');
                const count = document.getElementById('historyCount');
                
                if (!container) return;
                
                // Update count
                if (count) {
                    count.textContent = `(${this.history.length})`;
                }
                
                // Render history items
                if (this.history.length === 0) {
                    container.innerHTML = '<div class="empty-history">No loadouts generated yet. Spin the slots to get started!</div>';
                } else {
                    container.innerHTML = this.history.map(item => `
                        <div class="history-item">
                            <div class="loadout-details">
                                <div class="loadout-class">${item.class || 'Unknown'}</div>
                                <div class="loadout-equipment">
                                    <div class="equipment-item">
                                        <span class="equipment-label">Weapon</span>
                                        <span class="equipment-value">${item.weapon}</span>
                                    </div>
                                    <div class="equipment-item">
                                        <span class="equipment-label">Spec</span>
                                        <span class="equipment-value">${item.specialization}</span>
                                    </div>
                                    <div class="equipment-item">
                                        <span class="equipment-label">Gadget 1</span>
                                        <span class="equipment-value">${item.gadget1}</span>
                                    </div>
                                    <div class="equipment-item">
                                        <span class="equipment-label">Gadget 2</span>
                                        <span class="equipment-value">${item.gadget2}</span>
                                    </div>
                                    <div class="equipment-item">
                                        <span class="equipment-label">Gadget 3</span>
                                        <span class="equipment-value">${item.gadget3}</span>
                                    </div>
                                </div>
                            </div>
                            <button class="copy-btn" data-id="${item.id}">📋 Copy</button>
                        </div>
                    `).join('');
                    
                    // Add copy event listeners
                    container.querySelectorAll('.copy-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = parseInt(e.target.dataset.id);
                            const loadout = this.history.find(h => h.id === id);
                            if (loadout) this.copyLoadout(loadout);
                        });
                    });
                }
            }
        }
        
        // Initialize history manager
        window.loadoutHistory = new LoadoutHistory();
        
        // Hook into the premium slot machine to capture loadouts
        const originalStartSlotMachine = window.premiumIntegrated?.startSlotMachine;
        if (window.premiumIntegrated && originalStartSlotMachine) {
            window.premiumIntegrated.startSlotMachine = async function() {
                const result = await originalStartSlotMachine.apply(this, arguments);
                
                // Add loadout to history after generation
                if (this.currentLoadout) {
                    const loadout = {
                        ...this.currentLoadout,
                        class: this.selectedClass ? this.selectedClass.charAt(0).toUpperCase() + this.selectedClass.slice(1) : 'Unknown'
                    };
                    window.loadoutHistory.addLoadout(loadout);
                }
                
                return result;
            }.bind(window.premiumIntegrated);
        }
    </script>
    
    <!-- Filter System Script -->
    <script>
        class FilterSystem {
            constructor() {
                this.filterState = {};
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.loadFilterState();
                
                // Wait for premium integrated to be ready
                const checkReady = setInterval(() => {
                    if (window.premiumIntegrated && window.premiumIntegrated.loadoutData) {
                        clearInterval(checkReady);
                        this.populateFilters();
                    }
                }, 100);
            }
            
            setupEventListeners() {
                // Secondary filter button - prominent placement
                const secondaryBtn = document.getElementById('secondary-filter-button');
                if (secondaryBtn) {
                    secondaryBtn.addEventListener('click', () => {
                        this.togglePanel();
                        // Remove pulse animation after first click
                        secondaryBtn.classList.add('clicked');
                    });
                }
                
                // Close button
                const closeBtn = document.getElementById('close-filter-panel');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.closePanel());
                }
                
                // Overlay click
                const overlay = document.getElementById('filter-panel-overlay');
                if (overlay) {
                    overlay.addEventListener('click', () => this.closePanel());
                }
                
                // Apply button
                const applyBtn = document.getElementById('apply-filters');
                if (applyBtn) {
                    applyBtn.addEventListener('click', () => this.applyFilters());
                }
                
                // Clear button
                const clearBtn = document.getElementById('clear-filters');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => this.clearAllFilters());
                }
                
                // Reset All Filters button
                const resetBtn = document.getElementById('reset-all-filters');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        this.clearAllFilters();
                        this.applyFilters();
                        this.closePanel();
                    });
                }
            }
            
            togglePanel() {
                const panel = document.getElementById('filter-panel');
                const overlay = document.getElementById('filter-panel-overlay');
                
                if (panel && overlay) {
                    const isActive = panel.classList.contains('active');
                    if (isActive) {
                        this.closePanel();
                    } else {
                        panel.classList.add('active');
                        overlay.classList.add('active');
                    }
                }
            }
            
            closePanel() {
                const panel = document.getElementById('filter-panel');
                const overlay = document.getElementById('filter-panel-overlay');
                
                if (panel && overlay) {
                    panel.classList.remove('active');
                    overlay.classList.remove('active');
                }
            }
            
            populateFilters() {
                const container = document.getElementById('filter-content');
                if (!container || !window.premiumIntegrated) return;
                
                const data = window.premiumIntegrated.getGameData();
                if (!data) return;
                
                container.innerHTML = '';
                
                ['Light', 'Medium', 'Heavy'].forEach(className => {
                    const section = document.createElement('div');
                    section.className = 'filter-section';
                    section.innerHTML = `<h3 class="filter-class-title">${className} Class</h3>`;
                    
                    // Weapons
                    const weaponsDiv = this.createFilterCategory('Weapons', data[className].weapons, className, 'weapon');
                    section.appendChild(weaponsDiv);
                    
                    // Specializations
                    const specsDiv = this.createFilterCategory('Specializations', data[className].specializations, className, 'specialization');
                    section.appendChild(specsDiv);
                    
                    // Gadgets
                    const gadgetsDiv = this.createFilterCategory('Gadgets', data[className].gadgets, className, 'gadget');
                    section.appendChild(gadgetsDiv);
                    
                    container.appendChild(section);
                });
            }
            
            createFilterCategory(title, items, className, type) {
                const div = document.createElement('div');
                div.className = 'filter-category';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'filter-category-title';
                titleDiv.innerHTML = `
                    <span>${title}</span>
                    <label class="select-all-checkbox">
                        <input type="checkbox" data-class="${className}" data-type="${type}" data-select-all="true" checked>
                        <span>Select All</span>
                    </label>
                `;
                div.appendChild(titleDiv);
                
                const itemsDiv = document.createElement('div');
                itemsDiv.className = 'filter-items';
                
                items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'filter-item';
                    itemDiv.innerHTML = `
                        <input type="checkbox" id="${className}-${type}-${item}" 
                               data-class="${className}" 
                               data-type="${type}" 
                               value="${item}" 
                               checked>
                        <label for="${className}-${type}-${item}">${item}</label>
                    `;
                    itemsDiv.appendChild(itemDiv);
                });
                
                div.appendChild(itemsDiv);
                
                // Setup select all functionality
                const selectAll = titleDiv.querySelector('[data-select-all]');
                if (selectAll) {
                    selectAll.addEventListener('change', (e) => {
                        const checkboxes = itemsDiv.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(cb => cb.checked = e.target.checked);
                    });
                }
                
                // Update select all when individual items change
                itemsDiv.addEventListener('change', () => {
                    const total = itemsDiv.querySelectorAll('input[type="checkbox"]').length;
                    const checked = itemsDiv.querySelectorAll('input[type="checkbox"]:checked').length;
                    if (selectAll) {
                        selectAll.checked = checked === total;
                        selectAll.indeterminate = checked > 0 && checked < total;
                    }
                });
                
                return div;
            }
            
            applyFilters() {
                if (!window.premiumIntegrated) return;
                
                const filterState = {
                    Light: { weapons: [], specializations: [], gadgets: [] },
                    Medium: { weapons: [], specializations: [], gadgets: [] },
                    Heavy: { weapons: [], specializations: [], gadgets: [] }
                };
                
                // Get all unchecked items (these will be filtered out)
                const uncheckedBoxes = document.querySelectorAll('#filter-content input[type="checkbox"]:not(:checked):not([data-select-all])');
                
                // Update filter count badge
                const filterCount = uncheckedBoxes.length;
                const badge = document.getElementById('filter-count-badge');
                if (badge) {
                    if (filterCount > 0) {
                        badge.textContent = filterCount;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
                
                uncheckedBoxes.forEach(checkbox => {
                    const className = checkbox.dataset.class;
                    const type = checkbox.dataset.type;
                    const value = checkbox.value;
                    
                    if (type === 'weapon') {
                        filterState[className].weapons.push(value);
                    } else if (type === 'specialization') {
                        filterState[className].specializations.push(value);
                    } else if (type === 'gadget') {
                        filterState[className].gadgets.push(value);
                    }
                });
                
                // Validate filters
                const errors = this.validateFilters(filterState);
                if (errors.length > 0) {
                    alert('Filter validation failed:\n\n' + errors.join('\n'));
                    return;
                }
                
                // Apply filters
                window.premiumIntegrated.filterState = filterState;
                window.premiumIntegrated.saveFilterState();
                
                this.closePanel();
                
                // Show confirmation
                this.showToast('Filters applied successfully!');
            }
            
            validateFilters(filterState) {
                const errors = [];
                const data = window.premiumIntegrated.getGameData();
                
                ['Light', 'Medium', 'Heavy'].forEach(className => {
                    const classData = data[className];
                    const filters = filterState[className];
                    
                    // Check weapons
                    const availableWeapons = classData.weapons.filter(w => !filters.weapons.includes(w));
                    if (availableWeapons.length === 0) {
                        errors.push(`${className}: At least 1 weapon must be available`);
                    }
                    
                    // Check specializations
                    const availableSpecs = classData.specializations.filter(s => !filters.specializations.includes(s));
                    if (availableSpecs.length === 0) {
                        errors.push(`${className}: At least 1 specialization must be available`);
                    }
                    
                    // Check gadgets
                    const availableGadgets = classData.gadgets.filter(g => !filters.gadgets.includes(g));
                    if (availableGadgets.length < 3) {
                        errors.push(`${className}: At least 3 gadgets must be available`);
                    }
                });
                
                return errors;
            }
            
            clearAllFilters() {
                const checkboxes = document.querySelectorAll('#filter-content input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = true);
                
                // Clear the filter count badge
                const badge = document.getElementById('filter-count-badge');
                if (badge) {
                    badge.style.display = 'none';
                }
                
                if (window.premiumIntegrated) {
                    window.premiumIntegrated.filterState = {
                        Light: { weapons: [], specializations: [], gadgets: [] },
                        Medium: { weapons: [], specializations: [], gadgets: [] },
                        Heavy: { weapons: [], specializations: [], gadgets: [] }
                    };
                    window.premiumIntegrated.saveFilterState();
                }
                
                this.showToast('All filters cleared!');
            }
            
            loadFilterState() {
                if (!window.premiumIntegrated) return;
                
                const filterState = window.premiumIntegrated.filterState;
                if (!filterState) return;
                
                // Apply saved filter state to checkboxes
                Object.keys(filterState).forEach(className => {
                    const classFilters = filterState[className];
                    
                    // Uncheck filtered items
                    classFilters.weapons.forEach(item => {
                        const checkbox = document.querySelector(`#${className}-weapon-${item}`);
                        if (checkbox) checkbox.checked = false;
                    });
                    
                    classFilters.specializations.forEach(item => {
                        const checkbox = document.querySelector(`#${className}-specialization-${item}`);
                        if (checkbox) checkbox.checked = false;
                    });
                    
                    classFilters.gadgets.forEach(item => {
                        const checkbox = document.querySelector(`#${className}-gadget-${item}`);
                        if (checkbox) checkbox.checked = false;
                    });
                });
            }
            
            showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'filter-toast';
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 240, 192, 0.9);
                    color: #000;
                    padding: 1rem 2rem;
                    border-radius: 8px;
                    font-weight: 600;
                    z-index: 2000;
                    animation: slideUp 0.3s ease;
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideDown 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            }
        }
        
        // Add toast animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideUp {
                from { transform: translate(-50%, 100%); opacity: 0; }
                to { transform: translate(-50%, 0); opacity: 1; }
            }
            @keyframes slideDown {
                from { transform: translate(-50%, 0); opacity: 1; }
                to { transform: translate(-50%, 100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Initialize filter system
        window.filterSystem = new FilterSystem();
        
        // Scroll Progress Bar
        function updateScrollProgress() {
            const scrollTop = window.scrollY;
            const documentHeight = document.documentElement.scrollHeight - window.innerHeight;
            const scrollPercentage = documentHeight > 0 ? (scrollTop / documentHeight) * 100 : 0;
            const progressBar = document.getElementById('scrollProgress');
            if (progressBar) {
                progressBar.style.width = Math.min(scrollPercentage, 100) + '%';
            }
        }

        // Update on scroll
        window.addEventListener('scroll', updateScrollProgress);
        // Update on resize
        window.addEventListener('resize', updateScrollProgress);
        // Initial update
        document.addEventListener('DOMContentLoaded', updateScrollProgress);
    </script>
</body>
</html>