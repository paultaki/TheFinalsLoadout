<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE FINALS Loadout - OBS Overlay</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            color: #fff;
            overflow: hidden;
            width: 600px;
            height: 180px;
        }

        .overlay-container {
            background: linear-gradient(135deg, rgba(20, 10, 25, 0.98) 0%, rgba(35, 20, 40, 0.95) 100%);
            border-radius: 8px;
            border: 1px solid rgba(255, 71, 150, 0.4);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.9);
            width: 540px;
            height: 160px;
            padding: 8px 8px 12px 8px;
            margin: 10px auto;
        }

        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 6px 10px;
            background: linear-gradient(90deg, rgba(255, 71, 150, 0.15) 0%, rgba(150, 71, 255, 0.1) 100%);
            border-radius: 5px;
        }

        .class-name {
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .site-branding {
            font-size: 16px;
            background: linear-gradient(90deg, #ff4796, #ff71b0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }

        .class-light { color: #ff4796; }
        .class-medium { color: #9b59b6; }
        .class-heavy { color: #3498db; }

        .slot-columns {
            display: flex;
            gap: 0;
            justify-content: center;
        }

        .slot-column {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 71, 150, 0.2);
            border-right: none;
            padding: 6px;
            min-width: 100px;
            flex: 1;
        }

        .slot-column:first-child {
            border-radius: 6px 0 0 6px;
        }

        .slot-column:last-child {
            border-radius: 0 6px 6px 0;
            border-right: 1px solid rgba(255, 71, 150, 0.2);
        }

        .column-header {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            margin-bottom: 6px;
            color: #ff71b0;
            font-weight: bold;
        }

        .item-display {
            background: rgba(255, 71, 150, 0.06);
            border: 1px solid rgba(255, 71, 150, 0.15);
            border-radius: 4px;
            padding: 4px;
            text-align: center;
            height: 72px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .item-name {
            font-size: 10px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 4px;
        }

        .item-icon {
            font-size: 32px;
            margin: 4px 0;
        }

        .no-loadout {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.6);
        }

        .no-loadout h3 {
            margin-bottom: 10px;
            color: #ff4796;
        }

        .status {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 2px 5px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 3px;
            font-size: 10px;
            color: #0f0;
            display: none;
        }
    </style>
</head>
<body>
    <div id="overlayContainer" class="overlay-container">
        <div class="no-loadout">
            <h3>Waiting for Loadout...</h3>
            <p>Generate a loadout to display here</p>
        </div>
    </div>
    <div id="status" class="status"></div>

    <!-- Supabase Realtime for OBS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        console.log('ðŸŽ® OBS overlay starting...');

        // Get channel from URL
        const params = new URLSearchParams(window.location.search);
        const channelId = params.get('channel') || 'default';
        const debug = params.get('debug') === 'true';

        if (debug) {
            document.getElementById('status').style.display = 'block';
            document.getElementById('status').textContent = 'Channel: ' + channelId;
        }

        // Function to render loadout
        function renderLoadout(loadout) {
            console.log('ðŸ“¦ Rendering loadout:', loadout);

            if (!loadout || !loadout.class) {
                console.log('No valid loadout to render');
                return;
            }

            const container = document.getElementById('overlayContainer');
            const classLower = loadout.class.toLowerCase();

            // Simple emoji icons for items
            const icons = {
                weapon: 'ðŸ”«',
                specialization: 'âš¡',
                gadget: 'ðŸŽ¯'
            };

            // Normalize loadout format
            const weapon = typeof loadout.weapon === 'object' ? loadout.weapon.name : loadout.weapon;
            const spec = typeof loadout.specialization === 'object' ? loadout.specialization.name : loadout.specialization;

            let gadgetsHTML = '';
            if (loadout.gadgets && loadout.gadgets.length > 0) {
                loadout.gadgets.forEach((gadget, i) => {
                    const name = typeof gadget === 'object' ? gadget.name : gadget;
                    gadgetsHTML += `
                        <div class="slot-column">
                            <div class="column-header">GADGET ${i + 1}</div>
                            <div class="item-display">
                                <div class="item-icon">${icons.gadget}</div>
                                <div class="item-name">${name || 'Empty'}</div>
                            </div>
                        </div>
                    `;
                });
            } else if (loadout.gadget1 || loadout.gadget2 || loadout.gadget3) {
                // Handle old format
                [loadout.gadget1, loadout.gadget2, loadout.gadget3].forEach((gadget, i) => {
                    if (gadget) {
                        gadgetsHTML += `
                            <div class="slot-column">
                                <div class="column-header">GADGET ${i + 1}</div>
                                <div class="item-display">
                                    <div class="item-icon">${icons.gadget}</div>
                                    <div class="item-name">${gadget}</div>
                                </div>
                            </div>
                        `;
                    }
                });
            }

            container.innerHTML = `
                <div class="class-header">
                    <div class="class-name class-${classLower}">${loadout.class} BUILD</div>
                    <div class="site-branding">TheFinalsLoadout.com</div>
                </div>
                <div class="slot-columns">
                    <div class="slot-column">
                        <div class="column-header">WEAPON</div>
                        <div class="item-display">
                            <div class="item-icon">${icons.weapon}</div>
                            <div class="item-name">${weapon || 'None'}</div>
                        </div>
                    </div>
                    <div class="slot-column">
                        <div class="column-header">SPECIALIZATION</div>
                        <div class="item-display">
                            <div class="item-icon">${icons.specialization}</div>
                            <div class="item-name">${spec || 'None'}</div>
                        </div>
                    </div>
                    ${gadgetsHTML}
                </div>
            `;

            // Store in sessionStorage for persistence
            sessionStorage.setItem('lastLoadout', JSON.stringify(loadout));
        }

        // Check for saved loadout on load
        const savedLoadout = sessionStorage.getItem('lastLoadout');
        if (savedLoadout) {
            try {
                renderLoadout(JSON.parse(savedLoadout));
            } catch (e) {
                console.error('Failed to parse saved loadout:', e);
            }
        }

        // Initialize Supabase
        const SUPABASE_URL = 'https://nabbbidjnmljaadmjjln.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5hYmJiaWRqbm1samFhZG1qamxuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcxNTI2MDAsImV4cCI6MjA1MjcyODYwMH0.C-apFqin1kBOOV8L3R8Y0cakcAU2A8KtFqQr2PwVHAc';

        try {
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            const channel = supabase.channel('obs_' + channelId);

            channel
                .on('broadcast', { event: 'loadout_update' }, (payload) => {
                    console.log('âœ… Received loadout from Supabase:', payload);
                    renderLoadout(payload.payload);

                    if (debug) {
                        document.getElementById('status').textContent = 'Updated: ' + new Date().toLocaleTimeString();
                    }
                })
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('âœ… Connected to Supabase channel: obs_' + channelId);
                        if (debug) {
                            document.getElementById('status').textContent = 'Connected: obs_' + channelId;
                        }
                    }
                });
        } catch (e) {
            console.error('Failed to initialize Supabase:', e);
            if (debug) {
                document.getElementById('status').textContent = 'Error: ' + e.message;
            }
        }

        // Also check URL parameters for direct loadout
        const urlLoadout = params.get('loadout');
        if (urlLoadout) {
            try {
                renderLoadout(JSON.parse(decodeURIComponent(urlLoadout)));
            } catch (e) {
                console.error('Failed to parse URL loadout:', e);
            }
        }

        // Simple URL params format
        if (params.get('class') && params.get('weapon')) {
            const simpleLoadout = {
                class: params.get('class'),
                weapon: params.get('weapon'),
                specialization: params.get('spec') || 'None',
                gadgets: []
            };
            if (params.get('g1')) simpleLoadout.gadgets.push(params.get('g1'));
            if (params.get('g2')) simpleLoadout.gadgets.push(params.get('g2'));
            if (params.get('g3')) simpleLoadout.gadgets.push(params.get('g3'));

            renderLoadout(simpleLoadout);
        }

        console.log('âœ… OBS overlay ready! Channel:', channelId);
    </script>
</body>
</html>