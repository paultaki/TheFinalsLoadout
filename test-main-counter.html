<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Main Counter</title>
</head>
<body>
    <h1>Main Page Counter Test</h1>

    <div style="padding: 20px; border: 1px solid #ccc; margin: 20px;">
        <h2>Counter Display</h2>
        <p>Total Loadouts: <span id="loadoutTotal" style="font-weight: bold; color: #00ff88;">Loading...</span></p>
        <p>Today's Loadouts: <span id="loadoutToday" style="font-weight: bold; color: #0088ff;">Loading...</span></p>
    </div>

    <div style="padding: 20px; border: 1px solid #ccc; margin: 20px;">
        <h2>Test Actions</h2>
        <button onclick="testTrack()" style="padding: 10px 20px; font-size: 16px; margin: 5px;">Track Loadout Spin</button>
        <button onclick="testSync()" style="padding: 10px 20px; font-size: 16px; margin: 5px;">Force Sync</button>
        <button onclick="testUpdate()" style="padding: 10px 20px; font-size: 16px; margin: 5px;">Update Display</button>
        <button onclick="checkDatabase()" style="padding: 10px 20px; font-size: 16px; margin: 5px;">Check Database</button>
    </div>

    <div style="padding: 20px; border: 1px solid #ccc; margin: 20px;">
        <h2>Console Output</h2>
        <pre id="console" style="background: #f0f0f0; padding: 10px; height: 200px; overflow-y: auto;"></pre>
    </div>

    <!-- Supabase Stats Tracking -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/stats-tracker.js"></script>

    <script>
        const consoleEl = document.getElementById('console');

        // Override console.log to show in page
        const originalLog = console.log;
        console.log = function() {
            originalLog.apply(console, arguments);
            const message = Array.from(arguments).join(' ');
            consoleEl.textContent += message + '\n';
            consoleEl.scrollTop = consoleEl.scrollHeight;
        };

        const originalError = console.error;
        console.error = function() {
            originalError.apply(console, arguments);
            const message = 'âŒ ' + Array.from(arguments).join(' ');
            consoleEl.textContent += message + '\n';
            consoleEl.scrollTop = consoleEl.scrollHeight;
        };

        function testTrack() {
            console.log('ðŸŽ¯ Tracking loadout spin...');
            if (window.StatsTracker) {
                window.StatsTracker.track('loadout');
            } else {
                console.error('StatsTracker not available');
            }
        }

        function testSync() {
            console.log('ðŸ”„ Forcing sync...');
            if (window.StatsTracker) {
                window.StatsTracker.syncNow();
            } else {
                console.error('StatsTracker not available');
            }
        }

        function testUpdate() {
            console.log('ðŸ“Š Updating display...');
            if (window.StatsTracker) {
                window.StatsTracker.updateDisplay();
            } else {
                console.error('StatsTracker not available');
            }
        }

        async function checkDatabase() {
            console.log('ðŸ” Checking database directly...');
            if (!window.StatsTracker || !window.StatsTracker.client) {
                console.error('StatsTracker client not available');
                return;
            }

            try {
                // Check spin_stats table
                const { data: stats, error: statsError } = await window.StatsTracker.client
                    .from('spin_stats')
                    .select('*')
                    .order('spin_type');

                if (statsError) {
                    console.error('Error fetching spin_stats:', statsError);
                } else {
                    console.log('spin_stats table:', JSON.stringify(stats, null, 2));
                }

                // Try the RPC function
                const { data: rpcData, error: rpcError } = await window.StatsTracker.client
                    .rpc('get_current_stats');

                if (rpcError) {
                    console.error('Error calling get_current_stats:', rpcError);
                } else {
                    console.log('get_current_stats result:', JSON.stringify(rpcData, null, 2));
                }
            } catch (err) {
                console.error('Database check failed:', err);
            }
        }

        // Auto-check on load
        setTimeout(() => {
            console.log('ðŸš€ Page loaded, checking initial state...');
            checkDatabase();
        }, 1000);
    </script>
</body>
</html>