<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase Connection</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #0f0;
            padding: 20px;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #0a0;
        }
        .log {
            background: #000;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 20px 0;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .connected { background: #0a0; color: #fff; }
        .disconnected { background: #a00; color: #fff; }
        .pending { background: #aa0; color: #000; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>üîç Supabase Connection Test</h1>

    <div id="status" class="status pending">Status: Initializing...</div>

    <div>
        <button onclick="sendToOBS()">Send Test to OBS Channel</button>
        <button onclick="listenToOBS()">Listen to OBS Channel</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <h2>Connection Log:</h2>
    <div id="log" class="log"></div>

    <h2>Instructions:</h2>
    <ol>
        <li>Click "Listen to OBS Channel" to start receiving</li>
        <li>Click "Send Test to OBS" to broadcast a test loadout</li>
        <li>Check if the message is received</li>
        <li>If working here, OBS should receive it too</li>
    </ol>

    <p>OBS URL to use: <code>https://thefinalsloadout.com/overlay/?channel=default</code></p>

    <script>
        const log = document.getElementById('log');
        const status = document.getElementById('status');
        let supabase = null;
        let obsChannel = null;
        let listening = false;

        function addLog(msg) {
            const time = new Date().toLocaleTimeString();
            log.textContent += `[${time}] ${msg}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(msg);
        }

        function clearLog() {
            log.textContent = '';
        }

        function updateStatus(msg, type) {
            status.textContent = `Status: ${msg}`;
            status.className = `status ${type}`;
        }

        // Initialize Supabase
        try {
            const SUPABASE_URL = 'https://vdwkgrgacwxjnofglbyn.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkd2tncmdhY3d4am5vZmdsYnluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMTU5MjcsImV4cCI6MjA3Mzg5MTkyN30.7EsHGeSQG2ueT_ydwjKMYoAHz9O_wIK5d79SsRBWmMc';

            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            addLog('‚úÖ Supabase client created');
            updateStatus('Supabase initialized', 'connected');
        } catch (e) {
            addLog('‚ùå Failed to create Supabase client: ' + e.message);
            updateStatus('Failed to initialize', 'disconnected');
        }

        function listenToOBS() {
            if (!supabase) {
                addLog('‚ùå Supabase not initialized');
                return;
            }

            if (listening) {
                addLog('Already listening to OBS channel');
                return;
            }

            try {
                // Subscribe to OBS channel
                obsChannel = supabase.channel('obs_default');

                obsChannel
                    .on('broadcast', { event: 'loadout_update' }, (payload) => {
                        addLog('üì® RECEIVED loadout from OBS channel:');
                        addLog(JSON.stringify(payload.payload, null, 2));
                        updateStatus('Message received!', 'connected');
                    })
                    .subscribe((status) => {
                        addLog(`Channel status: ${status}`);
                        if (status === 'SUBSCRIBED') {
                            addLog('‚úÖ Listening to OBS channel: obs_default');
                            updateStatus('Connected and listening', 'connected');
                            listening = true;
                        } else if (status === 'SUBSCRIBING') {
                            updateStatus('Connecting...', 'pending');
                        } else if (status === 'UNSUBSCRIBED' || status === 'UNSUBSCRIBING') {
                            updateStatus('Disconnected', 'disconnected');
                            listening = false;
                        }
                    });
            } catch (e) {
                addLog('‚ùå Error subscribing: ' + e.message);
                updateStatus('Subscription error', 'disconnected');
            }
        }

        function sendToOBS() {
            if (!supabase) {
                addLog('‚ùå Supabase not initialized');
                return;
            }

            const testLoadout = {
                class: 'Heavy',
                name: 'Supabase Test',
                weapon: { name: 'SA1216', image: '/images/SA1216.webp' },
                specialization: { name: 'Mesh Shield', image: '/images/Mesh_Shield.webp' },
                gadgets: [
                    { name: 'RPG-7', image: '/images/RPG-7.webp' },
                    { name: 'C4', image: '/images/C4.webp' },
                    { name: 'Barricade', image: '/images/Barricade.webp' }
                ],
                timestamp: new Date().toISOString()
            };

            try {
                const sendChannel = supabase.channel('obs_default_send');

                sendChannel.subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        addLog('üì§ Sending test loadout to OBS channel...');

                        sendChannel.send({
                            type: 'broadcast',
                            event: 'loadout_update',
                            payload: testLoadout
                        }).then(() => {
                            addLog('‚úÖ Message sent successfully');
                            updateStatus('Message sent!', 'connected');
                            setTimeout(() => sendChannel.unsubscribe(), 100);
                        }).catch(err => {
                            addLog('‚ùå Send error: ' + err.message);
                            updateStatus('Send failed', 'disconnected');
                        });
                    } else {
                        addLog(`Send channel status: ${status}`);
                    }
                });
            } catch (e) {
                addLog('‚ùå Error sending: ' + e.message);
                updateStatus('Send error', 'disconnected');
            }
        }

        // Auto-start listening
        setTimeout(() => {
            addLog('Auto-starting listener...');
            listenToOBS();
        }, 1000);
    </script>
</body>
</html>