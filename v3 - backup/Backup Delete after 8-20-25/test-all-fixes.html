<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test All Slot Machine Fixes</title>
    
    <!-- Jam.dev Recording & Capture -->
    <meta name="jam:team" content="89d666eb-996b-4246-949a-939265963095" />
    <script type="module" src="https://js.jam.dev/recorder.js"></script>
    <script type="module" src="https://js.jam.dev/capture.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 20px;
            margin: 0;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #ff3366;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .test-card {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .test-card:hover {
            border-color: #ff3366;
            box-shadow: 0 0 20px rgba(255, 51, 102, 0.3);
        }
        
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .test-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ff6b9d;
        }
        
        .test-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .status-pending {
            background: #444;
            color: #aaa;
        }
        
        .status-running {
            background: #ff6b00;
            color: #fff;
            animation: pulse 1s infinite;
        }
        
        .status-passed {
            background: #00ff88;
            color: #000;
        }
        
        .status-failed {
            background: #ff0044;
            color: #fff;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .test-description {
            color: #999;
            margin-bottom: 15px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .test-actions {
            display: flex;
            gap: 10px;
        }
        
        .test-btn {
            flex: 1;
            padding: 10px;
            background: linear-gradient(135deg, #ff3366, #ff6b9d);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 51, 102, 0.4);
        }
        
        .test-btn:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
        }
        
        .test-results {
            margin-top: 15px;
            padding: 15px;
            background: #0a0a0a;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .test-results.show {
            display: block;
        }
        
        .result-line {
            margin: 5px 0;
            padding: 3px 0;
        }
        
        .result-success {
            color: #00ff88;
        }
        
        .result-error {
            color: #ff0044;
        }
        
        .result-warning {
            color: #ffaa00;
        }
        
        .result-info {
            color: #00aaff;
        }
        
        .control-panel {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .run-all-btn {
            padding: 15px 40px;
            background: linear-gradient(135deg, #00ff88, #00aaff);
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .run-all-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.5);
        }
        
        .summary {
            margin-top: 20px;
            padding: 15px;
            background: #0a0a0a;
            border-radius: 8px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .summary-label {
            color: #999;
            font-size: 0.9rem;
        }
        
        .iframe-container {
            display: none;
            position: fixed;
            top: 0;
            right: -100%;
            width: 50%;
            height: 100vh;
            background: #000;
            border-left: 2px solid #ff3366;
            transition: right 0.3s ease;
            z-index: 1000;
        }
        
        .iframe-container.show {
            display: block;
            right: 0;
        }
        
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .close-iframe {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 10px 20px;
            background: #ff3366;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🎰 The Finals Loadout v3 - Comprehensive Test Suite</h1>
        
        <div class="control-panel">
            <button class="run-all-btn" onclick="runAllTests()">🚀 RUN ALL TESTS</button>
            
            <div class="summary">
                <div class="summary-item">
                    <div class="summary-value" id="total-tests">5</div>
                    <div class="summary-label">Total Tests</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="passed-tests" style="color: #00ff88;">0</div>
                    <div class="summary-label">Passed</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="failed-tests" style="color: #ff0044;">0</div>
                    <div class="summary-label">Failed</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="pending-tests" style="color: #ffaa00;">5</div>
                    <div class="summary-label">Pending</div>
                </div>
            </div>
        </div>
        
        <div class="test-grid">
            <!-- Test 1: Spin Counter Progression -->
            <div class="test-card" data-test-id="spin-counter">
                <div class="test-header">
                    <div class="test-title">Spin Counter Progression</div>
                    <div class="test-status status-pending">PENDING</div>
                </div>
                <div class="test-description">
                    Verifies that the spin counter shows "1 of 5", "2 of 5", etc. sequentially without jumping to the final value.
                </div>
                <div class="test-actions">
                    <button class="test-btn" onclick="runTest('spin-counter')">Run Test</button>
                    <button class="test-btn" onclick="openTestPage('test-counter-fix.html')">View Demo</button>
                </div>
                <div class="test-results"></div>
            </div>
            
            <!-- Test 2: Landing Position Accuracy -->
            <div class="test-card" data-test-id="landing-position">
                <div class="test-header">
                    <div class="test-title">Landing Position (-1520px)</div>
                    <div class="test-status status-pending">PENDING</div>
                </div>
                <div class="test-description">
                    Ensures the slot machine lands exactly at -1520px (±2px tolerance) for proper winner alignment.
                </div>
                <div class="test-actions">
                    <button class="test-btn" onclick="runTest('landing-position')">Run Test</button>
                    <button class="test-btn" onclick="openTestPage('position-math-test.js')">View Code</button>
                </div>
                <div class="test-results"></div>
            </div>
            
            <!-- Test 3: DOM Manipulation (No Blank Frames) -->
            <div class="test-card" data-test-id="dom-manipulation">
                <div class="test-header">
                    <div class="test-title">DOM Differential Updates</div>
                    <div class="test-status status-pending">PENDING</div>
                </div>
                <div class="test-description">
                    Verifies no "Blank frame detected" errors occur during spins with the new differential DOM update system.
                </div>
                <div class="test-actions">
                    <button class="test-btn" onclick="runTest('dom-manipulation')">Run Test</button>
                    <button class="test-btn" onclick="openTestPage('test-blank-cards-fix.html')">View Demo</button>
                </div>
                <div class="test-results"></div>
            </div>
            
            <!-- Test 4: Winner Highlighting Timing -->
            <div class="test-card" data-test-id="winner-timing">
                <div class="test-header">
                    <div class="test-title">700ms Winner Highlight Delay</div>
                    <div class="test-status status-pending">PENDING</div>
                </div>
                <div class="test-description">
                    Confirms winners are highlighted exactly 700ms after the spin completes, not during motion.
                </div>
                <div class="test-actions">
                    <button class="test-btn" onclick="runTest('winner-timing')">Run Test</button>
                    <button class="test-btn" onclick="openTestPage('index.html')">View Live</button>
                </div>
                <div class="test-results"></div>
            </div>
            
            <!-- Test 5: Multi-Spin Continuity -->
            <div class="test-card" data-test-id="multi-spin">
                <div class="test-header">
                    <div class="test-title">Multi-Spin Continuity</div>
                    <div class="test-status status-pending">PENDING</div>
                </div>
                <div class="test-description">
                    Tests smooth transitions between consecutive spins without DOM rebuilds or visual glitches.
                </div>
                <div class="test-actions">
                    <button class="test-btn" onclick="runTest('multi-spin')">Run Test</button>
                    <button class="test-btn" onclick="openTestPage('test-multi-spin.html')">View Demo</button>
                </div>
                <div class="test-results"></div>
            </div>
        </div>
    </div>
    
    <!-- Hidden iframe for testing -->
    <div class="iframe-container" id="test-iframe-container">
        <button class="close-iframe" onclick="closeTestPage()">✕ Close</button>
        <iframe id="test-iframe"></iframe>
    </div>
    
    <script>
        // Test state tracking
        const testResults = {
            'spin-counter': null,
            'landing-position': null,
            'dom-manipulation': null,
            'winner-timing': null,
            'multi-spin': null
        };
        
        // Update summary counts
        function updateSummary() {
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r === 'passed').length;
            const failed = Object.values(testResults).filter(r => r === 'failed').length;
            const pending = total - passed - failed;
            
            document.getElementById('total-tests').textContent = total;
            document.getElementById('passed-tests').textContent = passed;
            document.getElementById('failed-tests').textContent = failed;
            document.getElementById('pending-tests').textContent = pending;
        }
        
        // Run individual test
        async function runTest(testId) {
            const card = document.querySelector(`[data-test-id="${testId}"]`);
            const status = card.querySelector('.test-status');
            const results = card.querySelector('.test-results');
            const button = card.querySelector('.test-btn');
            
            // Update UI to running state
            status.className = 'test-status status-running';
            status.textContent = 'RUNNING';
            button.disabled = true;
            results.className = 'test-results show';
            results.innerHTML = '<div class="result-line result-info">🔄 Starting test...</div>';
            
            try {
                // Run the specific test
                const testPassed = await executeTest(testId, results);
                
                // Update status
                if (testPassed) {
                    status.className = 'test-status status-passed';
                    status.textContent = 'PASSED';
                    testResults[testId] = 'passed';
                    results.innerHTML += '<div class="result-line result-success">✅ Test passed successfully!</div>';
                } else {
                    status.className = 'test-status status-failed';
                    status.textContent = 'FAILED';
                    testResults[testId] = 'failed';
                    results.innerHTML += '<div class="result-line result-error">❌ Test failed - see details above</div>';
                }
            } catch (error) {
                status.className = 'test-status status-failed';
                status.textContent = 'ERROR';
                testResults[testId] = 'failed';
                results.innerHTML += `<div class="result-line result-error">❌ Error: ${error.message}</div>`;
            } finally {
                button.disabled = false;
                updateSummary();
            }
        }
        
        // Execute specific test logic
        async function executeTest(testId, resultsDiv) {
            switch(testId) {
                case 'spin-counter':
                    return await testSpinCounter(resultsDiv);
                case 'landing-position':
                    return await testLandingPosition(resultsDiv);
                case 'dom-manipulation':
                    return await testDomManipulation(resultsDiv);
                case 'winner-timing':
                    return await testWinnerTiming(resultsDiv);
                case 'multi-spin':
                    return await testMultiSpin(resultsDiv);
                default:
                    throw new Error(`Unknown test: ${testId}`);
            }
        }
        
        // Test 1: Spin Counter Progression
        async function testSpinCounter(resultsDiv) {
            resultsDiv.innerHTML += '<div class="result-line result-info">📊 Loading main application...</div>';
            
            const iframe = document.createElement('iframe');
            iframe.src = 'index.html';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            await new Promise(resolve => {
                iframe.onload = resolve;
            });
            
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            const iframeWin = iframe.contentWindow;
            
            // Wait for slot machine to initialize
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            resultsDiv.innerHTML += '<div class="result-line result-info">🎰 Simulating 5-spin sequence...</div>';
            
            // Monitor console for counter updates
            const counterValues = [];
            const originalLog = iframeWin.console.log;
            iframeWin.console.log = function(...args) {
                const msg = args.join(' ');
                if (msg.includes('[COUNTER]') || msg.includes('Spin') || msg.includes('of')) {
                    counterValues.push(msg);
                }
                originalLog.apply(iframeWin.console, args);
            };
            
            // Trigger spin
            const generateBtn = iframeDoc.getElementById('generate-btn');
            if (generateBtn) {
                generateBtn.click();
                resultsDiv.innerHTML += '<div class="result-line result-info">⏳ Monitoring counter progression...</div>';
                
                // Wait for spins to complete
                await new Promise(resolve => setTimeout(resolve, 5000));
                
                // Check results
                const hasProgression = counterValues.some(v => v.includes('1 of')) &&
                                      counterValues.some(v => v.includes('2 of')) &&
                                      counterValues.some(v => v.includes('3 of'));
                
                if (hasProgression) {
                    resultsDiv.innerHTML += '<div class="result-line result-success">✓ Counter shows proper progression</div>';
                } else {
                    resultsDiv.innerHTML += '<div class="result-line result-error">✗ Counter jumps to final value</div>';
                }
                
                iframe.remove();
                return hasProgression;
            }
            
            iframe.remove();
            throw new Error('Could not find generate button');
        }
        
        // Test 2: Landing Position
        async function testLandingPosition(resultsDiv) {
            resultsDiv.innerHTML += '<div class="result-line result-info">🎯 Testing landing position calculation...</div>';
            
            // Test the math directly
            const ITEM_HEIGHT = 80;
            const winnerIndex = 20;
            const targetPosition = -(winnerIndex * ITEM_HEIGHT) + ITEM_HEIGHT; // -1520px
            
            resultsDiv.innerHTML += `<div class="result-line result-info">📐 Winner index: ${winnerIndex}</div>`;
            resultsDiv.innerHTML += `<div class="result-line result-info">📐 Item height: ${ITEM_HEIGHT}px</div>`;
            resultsDiv.innerHTML += `<div class="result-line result-info">📐 Calculated position: ${targetPosition}px</div>`;
            
            const isCorrect = targetPosition === -1520;
            
            if (isCorrect) {
                resultsDiv.innerHTML += '<div class="result-line result-success">✓ Landing position correctly calculated as -1520px</div>';
            } else {
                resultsDiv.innerHTML += `<div class="result-line result-error">✗ Incorrect position: ${targetPosition}px (expected -1520px)</div>`;
            }
            
            return isCorrect;
        }
        
        // Test 3: DOM Manipulation
        async function testDomManipulation(resultsDiv) {
            resultsDiv.innerHTML += '<div class="result-line result-info">🔧 Testing differential DOM updates...</div>';
            
            // Check if the new differential update code exists
            const response = await fetch('slot-machine.js');
            const code = await response.text();
            
            const hasDifferentialUpdate = code.includes('DIFFERENTIAL UPDATE') || 
                                         code.includes('Update existing items instead of clearing');
            const hasHelperMethods = code.includes('createItemElement') && 
                                   code.includes('getImagePath');
            
            resultsDiv.innerHTML += `<div class="result-line result-info">📝 Differential updates: ${hasDifferentialUpdate ? 'YES' : 'NO'}</div>`;
            resultsDiv.innerHTML += `<div class="result-line result-info">📝 Helper methods: ${hasHelperMethods ? 'YES' : 'NO'}</div>`;
            
            if (hasDifferentialUpdate) {
                resultsDiv.innerHTML += '<div class="result-line result-success">✓ Differential DOM updates implemented</div>';
            } else {
                resultsDiv.innerHTML += '<div class="result-line result-error">✗ Still using innerHTML clearing</div>';
            }
            
            if (hasHelperMethods) {
                resultsDiv.innerHTML += '<div class="result-line result-success">✓ Helper methods added</div>';
            } else {
                resultsDiv.innerHTML += '<div class="result-line result-error">✗ Missing helper methods</div>';
            }
            
            return hasDifferentialUpdate && hasHelperMethods;
        }
        
        // Test 4: Winner Timing
        async function testWinnerTiming(resultsDiv) {
            resultsDiv.innerHTML += '<div class="result-line result-info">⏱️ Testing winner highlight timing...</div>';
            
            // Check if the 700ms delay is implemented
            const response = await fetch('app.js');
            const code = await response.text();
            
            const has700msDelay = code.includes('700') && 
                                 (code.includes('700ms delay') || code.includes('setTimeout'));
            
            resultsDiv.innerHTML += `<div class="result-line result-info">📝 700ms delay implemented: ${has700msDelay ? 'YES' : 'NO'}</div>`;
            
            if (has700msDelay) {
                resultsDiv.innerHTML += '<div class="result-line result-success">✓ Winner highlighting delayed by 700ms</div>';
                
                // Extract the actual delay value
                const delayMatch = code.match(/setTimeout[^,]+,\s*(\d+)\)/);
                if (delayMatch) {
                    const delay = parseInt(delayMatch[1]);
                    resultsDiv.innerHTML += `<div class="result-line result-info">⏱️ Actual delay: ${delay}ms</div>`;
                    
                    if (delay === 700) {
                        resultsDiv.innerHTML += '<div class="result-line result-success">✓ Delay is exactly 700ms</div>';
                        return true;
                    } else {
                        resultsDiv.innerHTML += `<div class="result-line result-warning">⚠️ Delay is ${delay}ms, not 700ms</div>`;
                        return false;
                    }
                }
            } else {
                resultsDiv.innerHTML += '<div class="result-line result-error">✗ 700ms delay not found</div>';
            }
            
            return has700msDelay;
        }
        
        // Test 5: Multi-Spin
        async function testMultiSpin(resultsDiv) {
            resultsDiv.innerHTML += '<div class="result-line result-info">🔄 Testing multi-spin continuity...</div>';
            
            // Check if preservePosition parameter is used
            const response = await fetch('slot-machine.js');
            const code = await response.text();
            
            const hasPreservePosition = code.includes('preservePosition');
            const hasDifferentialUpdates = code.includes('DIFFERENTIAL UPDATE');
            
            resultsDiv.innerHTML += `<div class="result-line result-info">📝 Position preservation: ${hasPreservePosition ? 'YES' : 'NO'}</div>`;
            resultsDiv.innerHTML += `<div class="result-line result-info">📝 Differential updates: ${hasDifferentialUpdates ? 'YES' : 'NO'}</div>`;
            
            if (hasPreservePosition) {
                resultsDiv.innerHTML += '<div class="result-line result-success">✓ Position preserved between spins</div>';
            } else {
                resultsDiv.innerHTML += '<div class="result-line result-error">✗ Position not preserved</div>';
            }
            
            if (hasDifferentialUpdates) {
                resultsDiv.innerHTML += '<div class="result-line result-success">✓ DOM continuity maintained</div>';
            } else {
                resultsDiv.innerHTML += '<div class="result-line result-error">✗ DOM rebuilt between spins</div>';
            }
            
            return hasPreservePosition && hasDifferentialUpdates;
        }
        
        // Run all tests
        async function runAllTests() {
            const testIds = Object.keys(testResults);
            
            for (const testId of testIds) {
                await runTest(testId);
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }
        
        // Open test page in iframe
        function openTestPage(page) {
            const container = document.getElementById('test-iframe-container');
            const iframe = document.getElementById('test-iframe');
            
            iframe.src = page;
            container.classList.add('show');
        }
        
        // Close test page
        function closeTestPage() {
            const container = document.getElementById('test-iframe-container');
            container.classList.remove('show');
        }
        
        // Initialize
        updateSummary();
    </script>
</body>
</html>