<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Final Animation Test</title>
  <style>
    body {
      background: #0a0a0a;
      color: #fff;
      font-family: monospace;
      padding: 20px;
    }
    
    .test-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .status {
      background: #111;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      border: 1px solid #333;
    }
    
    .check {
      margin: 10px 0;
      padding: 10px;
      background: #0a0a0a;
      border-radius: 4px;
    }
    
    .pass { border-left: 4px solid #0f0; }
    .fail { border-left: 4px solid #f00; }
    .info { border-left: 4px solid #0ff; }
    
    button {
      background: #ff3366;
      color: #fff;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      border-radius: 4px;
    }
    
    button:hover {
      background: #ff5577;
    }
    
    iframe {
      width: 100%;
      height: 700px;
      border: 2px solid #333;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .metrics {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    
    .metric {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #333;
      flex: 1;
      min-width: 200px;
    }
    
    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #ff3366;
    }
    
    .metric-label {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>üé∞ Final Animation Test Suite</h1>
    
    <div class="metrics">
      <div class="metric">
        <div class="metric-value" id="viewportHeight">-</div>
        <div class="metric-label">Viewport Height (should be 240px)</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="itemHeight">-</div>
        <div class="metric-label">Item Height (should be 80px)</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="visibleItems">-</div>
        <div class="metric-label">Visible Items (should be 3)</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="spinDirection">-</div>
        <div class="metric-label">Spin Direction</div>
      </div>
    </div>
    
    <div class="status" id="status">
      <h3>Test Status</h3>
      <div id="checks"></div>
    </div>
    
    <button onclick="runTests()">Run All Tests</button>
    <button onclick="testAnimation()">Test Animation</button>
    <button onclick="location.reload()">Reload</button>
    
    <iframe id="appFrame" src="/v3/index-complete-fix.html"></iframe>
  </div>
  
  <script>
    const frame = document.getElementById('appFrame');
    let testResults = [];
    
    frame.onload = function() {
      console.log('App loaded, ready for testing');
      setTimeout(runTests, 1000);
    };
    
    function addCheck(name, passed, details) {
      const check = { name, passed, details };
      testResults.push(check);
      
      const checksEl = document.getElementById('checks');
      const checkEl = document.createElement('div');
      checkEl.className = `check ${passed ? 'pass' : 'fail'}`;
      checkEl.innerHTML = `
        <strong>${passed ? '‚úÖ' : '‚ùå'} ${name}</strong>
        <div style="font-size: 12px; color: #888; margin-top: 5px;">${details}</div>
      `;
      checksEl.appendChild(checkEl);
      
      return passed;
    }
    
    function runTests() {
      testResults = [];
      document.getElementById('checks').innerHTML = '';
      
      const win = frame.contentWindow;
      const doc = frame.contentDocument;
      
      // Test 1: Viewport Height
      const slotWindows = doc.querySelectorAll('.slot-window');
      const viewportHeights = Array.from(slotWindows).map(w => w.offsetHeight);
      const avgHeight = viewportHeights.reduce((a,b) => a+b, 0) / viewportHeights.length;
      
      document.getElementById('viewportHeight').textContent = avgHeight + 'px';
      addCheck('Viewport Height', 
        viewportHeights.every(h => h === 240),
        `Heights: ${viewportHeights.join(', ')}px`
      );
      
      // Test 2: Item Height
      const items = doc.querySelectorAll('.slot-item');
      const itemHeights = new Set(Array.from(items).slice(0, 10).map(i => i.offsetHeight));
      const itemHeight = Array.from(itemHeights)[0] || 0;
      
      document.getElementById('itemHeight').textContent = itemHeight + 'px';
      addCheck('Item Height',
        itemHeights.size === 1 && itemHeight === 80,
        `Unique heights: ${Array.from(itemHeights).join(', ')}px`
      );
      
      // Test 3: Visible Items
      const visibleCount = Math.floor(avgHeight / itemHeight);
      document.getElementById('visibleItems').textContent = visibleCount;
      addCheck('Visible Items',
        visibleCount === 3,
        `${visibleCount} items visible (${avgHeight}px / ${itemHeight}px)`
      );
      
      // Test 4: Gap Check
      const slotHeader = doc.querySelector('.slot-header');
      const slotColumns = doc.querySelector('.slot-columns');
      let gap = 0;
      
      if (slotHeader && slotColumns) {
        const headerRect = slotHeader.getBoundingClientRect();
        const columnsRect = slotColumns.getBoundingClientRect();
        gap = columnsRect.top - headerRect.bottom;
      }
      
      addCheck('No Large Gap',
        gap < 30,
        `Gap between header and columns: ${gap.toFixed(1)}px`
      );
      
      // Test 5: Animation Engine
      const hasConsistentSpin = typeof win.ConsistentSpinAnimation !== 'undefined';
      const hasAnimation = hasConsistentSpin || typeof win.SimpleSpinAnimation !== 'undefined';
      
      addCheck('Animation Engine',
        hasAnimation,
        hasConsistentSpin ? 'ConsistentSpinAnimation loaded' : 'Using fallback animation'
      );
      
      // Test 6: Initial Positions
      const containers = doc.querySelectorAll('.slot-items');
      const positions = Array.from(containers).map(c => {
        const transform = c.style.transform;
        const match = transform ? transform.match(/translateY\((-?\d+(?:\.\d+)?)px\)/) : null;
        return match ? parseFloat(match[1]) : 0;
      });
      
      addCheck('Initial Positions',
        positions.every(p => p === 0 || p === -1440),
        `Positions: ${positions.map(p => p.toFixed(0)).join(', ')}px`
      );
      
      // Summary
      const passed = testResults.filter(r => r.passed).length;
      const total = testResults.length;
      
      const summaryEl = document.createElement('div');
      summaryEl.className = 'check info';
      summaryEl.innerHTML = `
        <strong>üìä Summary: ${passed}/${total} tests passed</strong>
        ${passed === total ? '<div style="color: #0f0; margin-top: 5px;">‚ú® All tests passed! Animation should work correctly.</div>' : ''}
      `;
      document.getElementById('checks').appendChild(summaryEl);
    }
    
    async function testAnimation() {
      const doc = frame.contentDocument;
      const generateBtn = doc.querySelector('.generate-btn');
      
      if (generateBtn) {
        // Clear previous results
        document.getElementById('spinDirection').textContent = 'Testing...';
        
        // Click generate button
        generateBtn.click();
        
        // Monitor spin direction
        setTimeout(() => {
          const containers = doc.querySelectorAll('.slot-items');
          const positions = [];
          
          // Take two measurements
          containers.forEach(c => {
            const transform = c.style.transform;
            const match = transform ? transform.match(/translateY\((-?\d+(?:\.\d+)?)px\)/) : null;
            positions.push(match ? parseFloat(match[1]) : 0);
          });
          
          setTimeout(() => {
            const newPositions = [];
            containers.forEach(c => {
              const transform = c.style.transform;
              const match = transform ? transform.match(/translateY\((-?\d+(?:\.\d+)?)px\)/) : null;
              newPositions.push(match ? parseFloat(match[1]) : 0);
            });
            
            // Check direction (negative change = downward scroll)
            const changes = positions.map((p, i) => newPositions[i] - p);
            const avgChange = changes.reduce((a,b) => a+b, 0) / changes.length;
            
            const direction = avgChange < 0 ? 'Downward ‚úÖ' : avgChange > 0 ? 'Upward ‚ùå' : 'Not moving';
            document.getElementById('spinDirection').textContent = direction;
            
            addCheck('Spin Direction Test',
              avgChange < 0,
              `Average change: ${avgChange.toFixed(1)}px (negative = downward)`
            );
          }, 500);
        }, 500);
      }
    }
  </script>
</body>
</html>