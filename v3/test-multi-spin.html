<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Spin Test Suite</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
        }
        .test-matrix {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        .test-card {
            border: 1px solid #0f0;
            padding: 10px;
            cursor: pointer;
        }
        .test-card:hover {
            background: #111;
        }
        .results {
            margin-top: 20px;
            border: 1px solid #0f0;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .pass { color: #0f0; }
        .fail { color: #f00; }
        .warn { color: #ff0; }
    </style>
</head>
<body>
    <h1>üß™ Multi-Spin Test Suite</h1>
    
    <div class="test-matrix">
        <div class="test-card" onclick="runTest('Light', 1)">Light - 1 Spin</div>
        <div class="test-card" onclick="runTest('Light', 3)">Light - 3 Spins</div>
        <div class="test-card" onclick="runTest('Light', 5)">Light - 5 Spins</div>
        <div class="test-card" onclick="runTest('Medium', 1)">Medium - 1 Spin</div>
        <div class="test-card" onclick="runTest('Medium', 3)">Medium - 3 Spins</div>
        <div class="test-card" onclick="runTest('Medium', 5)">Medium - 5 Spins</div>
        <div class="test-card" onclick="runTest('Heavy', 1)">Heavy - 1 Spin</div>
        <div class="test-card" onclick="runTest('Heavy', 3)">Heavy - 3 Spins</div>
        <div class="test-card" onclick="runTest('Heavy', 5)">Heavy - 5 Spins</div>
    </div>
    
    <button onclick="runAllTests()">üöÄ Run All Tests</button>
    <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    
    <div class="results" id="results">
        <h3>Test Results:</h3>
    </div>
    
    <script>
        const resultsDiv = document.getElementById('results');
        let testQueue = [];
        
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsDiv.appendChild(entry);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        function clearResults() {
            resultsDiv.innerHTML = '<h3>Test Results:</h3>';
        }
        
        async function runTest(classType, spinCount) {
            log(`\nüìã Testing ${classType} with ${spinCount} spin(s)...`, 'info');
            
            // Open test window
            const testWindow = window.open('/v3/', `test_${classType}_${spinCount}`, 'width=1200,height=800');
            
            if (!testWindow) {
                log('‚ùå Failed to open test window', 'fail');
                return;
            }
            
            // Wait for page to load
            await new Promise(resolve => {
                testWindow.onload = resolve;
                setTimeout(resolve, 2000); // Timeout fallback
            });
            
            // Inject test monitoring
            testWindow.console.oldLog = testWindow.console.log;
            let countersObserved = [];
            let spinsCompleted = 0;
            let eventFired = false;
            let finalPositions = [];
            
            testWindow.console.log = function(...args) {
                testWindow.console.oldLog(...args);
                const msg = args.join(' ');
                
                // Track counter updates
                if (msg.includes('[COUNTER] updateSpinCounter')) {
                    const match = msg.match(/current=(\d+), total=(\d+)/);
                    if (match) {
                        countersObserved.push(`${match[1]} of ${match[2]}`);
                    }
                }
                
                // Track spin completions
                if (msg.includes('[SPIN] quick done')) {
                    spinsCompleted++;
                    log(`  ‚úì Quick spin ${spinsCompleted} completed`, 'pass');
                }
                if (msg.includes('[SPIN] final done')) {
                    spinsCompleted++;
                    log(`  ‚úì Final spin completed`, 'pass');
                }
                
                // Track event dispatch
                if (msg.includes('[EVENT] slotSpinComplete')) {
                    eventFired = true;
                    log(`  ‚úì slotSpinComplete event fired`, 'pass');
                }
                
                // Track position assertions
                if (msg.includes('ASSERTION FAILED')) {
                    log(`  ‚ùå ${msg}`, 'fail');
                }
            };
            
            // Start the test
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Click start button
            const startBtn = testWindow.document.getElementById('start-flow-btn');
            if (startBtn) {
                startBtn.click();
                
                // Wait for spin selection
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Select spin count
                const spinBtn = testWindow.document.querySelector(`[data-value="${spinCount}"]`);
                if (spinBtn) {
                    spinBtn.click();
                    
                    // Wait for class selection
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Select class
                    const classBtn = testWindow.document.querySelector(`[data-class="${classType.toLowerCase()}"]`);
                    if (classBtn) {
                        classBtn.click();
                        
                        // Wait for animation to complete
                        await new Promise(resolve => setTimeout(resolve, spinCount * 2000 + 3000));
                        
                        // Check final positions
                        const columns = testWindow.document.querySelectorAll('.slot-items');
                        columns.forEach((col, i) => {
                            const transform = col.style.transform;
                            const match = transform.match(/translateY\((-?\d+(?:\.\d+)?)px\)/);
                            if (match) {
                                const pos = parseFloat(match[1]);
                                finalPositions.push(pos);
                                const diff = Math.abs(pos - (-1520));
                                if (diff <= 2) {
                                    log(`  ‚úì Column ${i+1} landed at ${pos}px (within ¬±2px)`, 'pass');
                                } else {
                                    log(`  ‚ùå Column ${i+1} landed at ${pos}px (off by ${diff}px)`, 'fail');
                                }
                            }
                        });
                        
                        // Validate results
                        log(`\nüìä Test Summary:`, 'info');
                        log(`  Counters observed: ${countersObserved.join(' ‚Üí ')}`, countersObserved.length === spinCount ? 'pass' : 'fail');
                        log(`  Spins completed: ${spinsCompleted}/${spinCount}`, spinsCompleted === spinCount ? 'pass' : 'fail');
                        log(`  Event fired: ${eventFired ? 'Yes' : 'No'}`, eventFired ? 'pass' : 'fail');
                        log(`  All centered: ${finalPositions.every(p => Math.abs(p - (-1520)) <= 2) ? 'Yes' : 'No'}`, 
                            finalPositions.every(p => Math.abs(p - (-1520)) <= 2) ? 'pass' : 'fail');
                    }
                }
            }
            
            // Close test window
            setTimeout(() => testWindow.close(), 1000);
        }
        
        async function runAllTests() {
            testQueue = [
                ['Light', 1], ['Light', 3], ['Light', 5],
                ['Medium', 1], ['Medium', 3], ['Medium', 5],
                ['Heavy', 1], ['Heavy', 3], ['Heavy', 5]
            ];
            
            log('\nüöÄ Starting full test suite...', 'info');
            
            for (const [classType, spins] of testQueue) {
                await runTest(classType, spins);
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
            log('\n‚úÖ All tests completed!', 'pass');
        }
    </script>
</body>
</html>