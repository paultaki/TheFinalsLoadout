<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Jam.dev Recording & Capture -->
    <meta name="jam:team" content="89d666eb-996b-4246-949a-939265963095" />
    <script type="module" src="https://js.jam.dev/recorder.js"></script>
    <script type="module" src="https://js.jam.dev/capture.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smooth Braking Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .slot-machine {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .slot-column {
            width: 120px;
            height: 240px;
            border: 2px solid #333;
            overflow: hidden;
            position: relative;
            background: #222;
        }
        
        .slot-items {
            transition: none;
        }
        
        .item {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #444;
            font-size: 18px;
            font-weight: bold;
        }
        
        .item:nth-child(odd) { background: #333; }
        .item:nth-child(even) { background: #444; }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        
        .info {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .physics-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        
        .physics-stat {
            background: #444;
            padding: 8px;
            border-radius: 3px;
            text-align: center;
        }
        
        .physics-stat .label { font-size: 12px; color: #aaa; }
        .physics-stat .value { font-size: 16px; font-weight: bold; color: #4CAF50; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Physics-Based Smooth Braking Test</h1>
        
        <div class="info">
            <h3>Test Configuration:</h3>
            <ul>
                <li><strong>Deceleration Rate:</strong> 800 px/s²</li>
                <li><strong>Position Epsilon:</strong> 0.5px</li>
                <li><strong>Velocity Threshold:</strong> 20 px/s</li>
                <li><strong>Target Position:</strong> Winner at center (index 20)</li>
                <li><strong>Expected Behavior:</strong> Smooth braking without snap-to-position</li>
            </ul>
        </div>
        
        <div class="physics-info" id="physicsInfo">
            <div class="physics-stat">
                <div class="label">Current Velocity</div>
                <div class="value" id="currentVelocity">0 px/s</div>
            </div>
            <div class="physics-stat">
                <div class="label">Distance to Target</div>
                <div class="value" id="distanceToTarget">0 px</div>
            </div>
            <div class="physics-stat">
                <div class="label">Braking Distance</div>
                <div class="value" id="brakingDistance">0 px</div>
            </div>
            <div class="physics-stat">
                <div class="label">Phase</div>
                <div class="value" id="currentPhase">idle</div>
            </div>
        </div>
        
        <div class="slot-machine">
            <div class="slot-column" data-column="0">
                <div class="slot-items">
                    <!-- Items will be generated by JavaScript -->
                </div>
            </div>
            <div class="slot-column" data-column="1">
                <div class="slot-items">
                    <!-- Items will be generated by JavaScript -->
                </div>
            </div>
            <div class="slot-column" data-column="2">
                <div class="slot-items">
                    <!-- Items will be generated by JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button id="testBtn" onclick="runSmoothBrakingTest()">Test Smooth Braking</button>
            <button id="enableDebugBtn" onclick="toggleDebug()">Enable Debug Mode</button>
            <button onclick="resetPositions()">Reset Positions</button>
        </div>
        
        <div class="info">
            <h3>What to Watch For:</h3>
            <ul>
                <li><strong>Smooth Deceleration:</strong> No abrupt speed changes during braking phase</li>
                <li><strong>Physics-Based Braking:</strong> Braking distance adapts to current velocity</li>
                <li><strong>Natural Completion:</strong> Animation ends when both position and velocity criteria are met</li>
                <li><strong>No Snap:</strong> Winner should settle smoothly at center without forced transitions</li>
                <li><strong>Monotonic Motion:</strong> Position should only move forward, never backward</li>
            </ul>
        </div>
    </div>

    <script src="animation-engine-v2.js"></script>
    <script>
        let engine;
        let isDebugEnabled = false;
        let monitoringInterval;
        
        // Initialize the test
        function init() {
            // Create animation engine
            engine = new AnimationEngineV2();
            
            // Generate slot items
            generateSlotItems();
            
            console.log('Smooth Braking Test initialized');
        }
        
        function generateSlotItems() {
            const columns = document.querySelectorAll('.slot-column');
            columns.forEach(column => {
                const itemsContainer = column.querySelector('.slot-items');
                itemsContainer.innerHTML = '';
                
                // Create 60 items (20 items visible at different positions)
                for (let i = 0; i < 60; i++) {
                    const item = document.createElement('div');
                    item.className = 'item';
                    item.textContent = `Item ${i}`;
                    
                    // Highlight the winner (index 20)
                    if (i === 20) {
                        item.style.background = '#4CAF50';
                        item.style.color = 'white';
                        item.textContent = 'WINNER';
                    }
                    
                    itemsContainer.appendChild(item);
                }
                
                // Set initial position (winner above viewport)
                itemsContainer.style.transform = 'translateY(-1600px)';
            });
        }
        
        async function runSmoothBrakingTest() {
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.textContent = 'Testing...';
            
            try {
                const columns = document.querySelectorAll('.slot-column');
                
                // Start monitoring physics data
                startPhysicsMonitoring();
                
                // Run the animation with physics-based braking
                await engine.animateSlotMachine(columns, null, null);
                
                // Stop monitoring
                stopPhysicsMonitoring();
                
                console.log('✅ Smooth braking test completed successfully');
                
            } catch (error) {
                console.error('❌ Test failed:', error);
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'Test Smooth Braking';
            }
        }
        
        function startPhysicsMonitoring() {
            monitoringInterval = setInterval(() => {
                const firstColumn = Array.from(engine.columnStates.values())[0];
                if (firstColumn) {
                    const distanceToTarget = firstColumn.targetY ? firstColumn.targetY - firstColumn.unwrappedY : 0;
                    const brakingDist = engine.calculateBrakingDistance(firstColumn.velocity);
                    
                    document.getElementById('currentVelocity').textContent = `${firstColumn.velocity.toFixed(1)} px/s`;
                    document.getElementById('distanceToTarget').textContent = `${distanceToTarget.toFixed(1)} px`;
                    document.getElementById('brakingDistance').textContent = `${brakingDist.toFixed(0)} px`;
                    document.getElementById('currentPhase').textContent = firstColumn.phase || 'idle';
                    
                    // Color code based on braking phase
                    const phaseElement = document.getElementById('currentPhase');
                    if (firstColumn.phase === 'braking') {
                        phaseElement.style.color = '#ff9800'; // Orange for braking
                    } else if (firstColumn.phase === 'cruise' || firstColumn.phase === 'cruise_extended') {
                        phaseElement.style.color = '#2196f3'; // Blue for cruise
                    } else {
                        phaseElement.style.color = '#4CAF50'; // Green for other phases
                    }
                }
            }, 50); // Update every 50ms
        }
        
        function stopPhysicsMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
        }
        
        function toggleDebug() {
            isDebugEnabled = !isDebugEnabled;
            engine.debug = isDebugEnabled;
            
            const btn = document.getElementById('enableDebugBtn');
            btn.textContent = isDebugEnabled ? 'Disable Debug Mode' : 'Enable Debug Mode';
            
            if (isDebugEnabled) {
                engine.createDebugPanel();
            } else {
                const debugPanel = document.getElementById('anim-debug-v2');
                if (debugPanel) {
                    debugPanel.remove();
                }
            }
        }
        
        function resetPositions() {
            engine.resetAnimation();
            generateSlotItems();
            stopPhysicsMonitoring();
            
            // Reset physics info display
            document.getElementById('currentVelocity').textContent = '0 px/s';
            document.getElementById('distanceToTarget').textContent = '0 px';
            document.getElementById('brakingDistance').textContent = '0 px';
            document.getElementById('currentPhase').textContent = 'idle';
        }
        
        // Initialize when page loads
        window.addEventListener('load', init);
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopPhysicsMonitoring();
        });
    </script>
</body>
</html>